{% extends "base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/contra-entry.css' %}">
<link rel="stylesheet" href="{% static 'js/search.js' %}">
<link rel="stylesheet" href="{% static 'css/style.css' %}" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">




<style>

    th {
        height: 45px;
    }
    .removeRowBtn {
        background: none;
        border: none;
        cursor: pointer;
        color: rgb(84, 7, 7);
    }

    @keyframes slideOut {
        from {
            opacity: 1;
            transform: translateX(0);
        }
        to {
            opacity: 0;
            transform: translateX(-100%);
        }
    }

    .slide-out {
        animation: slideOut 0.5s forwards;
    }

    .select-container {
            position: relative;
            width: 300px;
        }

        .select-container select {
            width: 100%;
            padding: 10px;
            /* border: 1px solid #ccc; */
        }

        .select-container .search-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            box-sizing: border-box;
            display: none; /* Hidden initially */
        }

        .select-container .search-input.active {
            display: block;
        }

        .select-container .select-options {
            display: none; /* Hidden initially */
            position: absolute;
            top: 100%;
            left: 0;
            width: 100%;
            background: #fff;
            border: 1px solid #ccc;
            max-height: 200px;
            overflow-y: auto;
            z-index: 1000;
        }

        .select-container .select-options div {
            padding: 10px;
            cursor: pointer;
        }

        .select-container .select-options div:hover {
            background-color: #f0f0f0;
        }
    </style>


</style>


<div class="group-data-[sidebar-size=lg]:ltr:md:ml-vertical-menu group-data-[sidebar-size=lg]:rtl:md:mr-vertical-menu group-data-[sidebar-size=md]:ltr:ml-vertical-menu-md group-data-[sidebar-size=md]:rtl:mr-vertical-menu-md group-data-[sidebar-size=sm]:ltr:ml-vertical-menu-sm group-data-[sidebar-size=sm]:rtl:mr-vertical-menu-sm pt-[calc(theme('spacing.header')_*_1)] pb-[calc(theme('spacing.header')_*_0.8)] px-4 group-data-[navbar=bordered]:pt-[calc(theme('spacing.header')_*_1.3)] group-data-[navbar=hidden]:pt-0 group-data-[layout=horizontal]:mx-auto group-data-[layout=horizontal]:max-w-screen-2xl group-data-[layout=horizontal]:px-0 group-data-[layout=horizontal]:group-data-[sidebar-size=lg]:ltr:md:ml-auto group-data-[layout=horizontal]:group-data-[sidebar-size=lg]:rtl:md:mr-auto group-data-[layout=horizontal]:md:pt-[calc(theme('spacing.header')_*_1.6)] group-data-[layout=horizontal]:px-3 group-data-[layout=horizontal]:group-data-[navbar=hidden]:pt-[calc(theme('spacing.header')_*_0.9)]">
    <div class="container-fluid group-data-[content=boxed]:max-w-boxed mx-auto">
<div class="container-fluid">
    <h4 class="py-5"></h4>
    <div class="center">
        <h2>Edit Journal Entry</h2>
        <h4 class="py-5"></h4>

        <form method="post" action="{% url 'main:edit_journal_entry' %}" class="mb-5" id="editReceiptForm" onsubmit="handleSubmit(event)">
            {% csrf_token %}
            <input type="hidden" name="edit" value="true">
            <input type="hidden" name="VoucherNo" value="{{ voucher_entries.0.VoucherNo }}">
            <input type="hidden" name="Series" value="{{ voucher_entries.0.Series }}">
            <div class="firstdiv">
                <div class="series">
                    <label for="series">Series</label>
                    <select name="series" id="series" onchange="updateSerialNo()" style="width: 180px; margin-right: 100px;">
                        <option value="{{ voucher_entries.0.series }}" selected>{{ voucher_entries.0.series }}</option>
                    </select>
                </div>
                
                <div class="secondediv grid-container">
                    <div class="grid-item">
                        <label for="voucher_no">Voucher No</label>
                        <input 
                            style="width: 180px; margin-right: 100px; text-align: center;" 
                            type="text" 
                            name="voucher_no" 
                            id="voucher_no" 
                            value="{{ voucher_entries.0.voucher_no }}" 
                            readonly
                        >
                    </div>
                    <div class="date grid-item">
                        <label for="vdate" style="padding-top: 5px;">Date : &nbsp</label>
                        <input style="width: 76%; margin: 0;" type="date" class="newinput" name="vdate" id="date" value="{{ voucher_entries.0.vdate|date:'Y-m-d' }}" required>
                    </div>
                </div>
            </div>

            <br><br><br>


            <br>
            <table id="dynamicTable" style="background-color: white !important;">
                <thead>
                    <tr>
                        <th>Sl No</th>
                        <th>Head</th>
                        <th>Narration</th>
                        <th>Debit</th>
                        <th>Credit</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="dynamicRows">
                    {% for entry in voucher_entries %}
                        <tr>
                            <td><input style="width:50px" type="text" name="SlNo[]" value="{{ forloop.counter }}" readonly></td>
  <td>
            <div class="select-container">
                <select class="account-head-select" name="head" required>
                    <option value="">Select an account</option>
                    {% for account in head_accounts %}
                        <option value="{{ account.account_code }}">{{ account.head }}</option>
                    {% endfor %}
                    {% if entry.accountcode not in valid_account_codes %}
                        <option value="{{ entry.accountcode }}" selected>{{ entry.accountcode }}</option>
                    {% endif %}
                </select>
                <input type="search" class="search-input" placeholder="Search...">
                <div class="select-options">
                    {% for account in head_accounts %}
                        <div data-value="{{ account.account_code }}">{{ account.head }}</div>
                    {% endfor %}
                    {% if entry.accountcode not in valid_account_codes %}
                        <div data-value="{{ entry.accountcode }}">{{ entry.accountcode }}</div>
                    {% endif %}
                </div>
            </div>
        </td>
                            
                            
                            
                            
                            
                            <td><input style="width: 300px" type="text" name="narration[]" value="{{ entry.narration }}" ></td>
                            <td><input style="width: 100px" type="number" name="dramount[]" value="{{ entry.dramount }}" step="0.01" ></td>
                            <td><input style="width: 100px" type="number" name="cramount[]" value="{{ entry.cramount }}" step="0.01" onkeydown="checkEnter(event)" ></td>
                            <td style="text-align: center;"><button type="button" class="removeRowBtn" title="Non Remove" onclick="removeRow(this)">  <i class="fas fa-trash-alt"></i></button></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <br><br>
            <div class="lastdiv">
                <div class="series">
                </div>
                <div class="lastdivright2">
                    <label for="total_amount">Total Amount</label>
                    <input style="margin-right: 0; width: 40%; text-align: center; background-color: rgb(86, 251, 251);" type="text" name="total_amount" id="total_amount" title="Debit total amount" readonly>
                </div>
                <div class="lastdivright">
                    <!-- <label for="total_amount">Total Amount</label> -->
                    <input style="margin-right: 0px; width: 60%; text-align: center; background-color: rgb(86, 251, 251);" type="text" name="total_amount2" id="total_amount2" title="Credit total amount" readonly>
                </div>
            </div>
            <br><br>
            <div class="box btns" style="display: flex; justify-content: center;">
                   
                   

                <button type="submit" class="addbutton"><i class='bx bxs-edit'></i> Save</button>
                <a href="{% url 'main:account_journal_entry' %}"><button type="button" class="exitbutton"><i class='bx bx-exit'></i> Cancel</button></a>
                <a href="#" id="deleteLink" onclick="confirmDelete('{{ voucher_entries.0.voucher_no }}')">
                    <button type="button" class="exitbutton">
                        <i class='bx bx-trash'></i> Delete
                    </button>
                </a>
                <!-- <button type="submit" class="addbutton" title="Submit form"><i class='bx bx-plus-medical'></i> Save</button> -->
                <!-- <a href=""><button type="button" class="exitbutton"  title="Clear this page"><i class='bx bx-exit'></i> Clear</button></a> -->
                <a href="{% url 'main:account_debit_table' %}"><button type="button" class="addbutton" title="Go to journal table"><i class='bx bx-search-alt-2'></i> Search</button></a>

                              <!-- <button type="submit" class="addbutton"><i class='bx bxs-edit'></i> Edit</button> -->
                <!-- <button type="button" class="exitbutton"><i class='bx bx-trash'></i> Delete</button> -->
            </div>
        </form>
    </div>
</div>
</div>
</div>

<!-- Select2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.2/dist/css/select2.min.css" rel="stylesheet" />

<!-- jQuery (necessary for Select2) -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<!-- Select2 JS -->
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-beta.2/dist/js/select2.min.js"></script>

<script>
    function handleSubmit(event) {
        // Handle the form submission
        const form = document.getElementById('editReceiptForm');
        const formData = new FormData(form);

        // Validate the form data here if necessary
        // Example: Check for non-empty fields, valid date formats, etc.

        // Submit the form if validation passes
        form.submit();
    }
    // JavaScript function to handle row addition with Enter key
    let rowCounter = document.querySelectorAll('#dynamicRows tr').length;

function handleSubmit(event) {
    // Handle the form submission
    const form = document.getElementById('editReceiptForm');
    const formData = new FormData(form);

    // Validate the form data here if necessary

    // Submit the form if validation passes
    form.submit();
}

function checkEnter(event) {
    if (event.key === 'Enter') {
        event.preventDefault(); // Prevents the default action, e.g., form submission
        addRow();
    }
}

function initializeSelectContainers() {
    document.querySelectorAll('.select-container').forEach(container => {
        const selectElement = container.querySelector('.account-head-select');
        const searchInput = container.querySelector('.search-input');
        const optionsContainer = container.querySelector('.select-options');
        const options = Array.from(optionsContainer.querySelectorAll('div'));

        selectElement.addEventListener('click', function() {
            searchInput.classList.add('active');
            searchInput.focus();
            optionsContainer.style.display = 'block';
        });

        searchInput.addEventListener('input', function() {
            const searchValue = searchInput.value.toLowerCase();
            options.forEach(option => {
                const text = option.textContent.toLowerCase();
                option.style.display = text.includes(searchValue) ? 'block' : 'none';
            });
        });

        options.forEach(option => {
            option.addEventListener('click', function() {
                selectElement.value = this.getAttribute('data-value');
                selectElement.dispatchEvent(new Event('change')); // Trigger change event
                selectElement.querySelector(`option[value="${this.getAttribute('data-value')}"]`).selected = true;
                searchInput.classList.remove('active');
                optionsContainer.style.display = 'none';
            });
        });
    });
}

initializeSelectContainers();

document.addEventListener('click', function(e) {
    if (!e.target.closest('.select-container')) {
        document.querySelectorAll('.search-input.active').forEach(input => {
            input.classList.remove('active');
        });
        document.querySelectorAll('.select-options').forEach(options => {
            options.style.display = 'none';
        });
    }
});

function addRow() {
    const tableBody = document.getElementById('dynamicRows');
    const newRow = document.createElement('tr');
    rowCounter++;

    newRow.innerHTML = `
        <td><input style="width:50px;" type="text" name="SlNo[]" value="${rowCounter}" readonly></td>
        <td>
            <div class="select-container">
                <select class="account-head-select" name="head" required>
                    <option value="">Select an account</option>
                    {% for account in head_accounts %}
                        <option value="{{ account.account_code }}">{{ account.head }}</option>
                    {% endfor %}
                    {% if entry.accountcode not in valid_account_codes %}
                        <option value="{{ entry.accountcode }}" selected>{{ entry.accountcode }}</option>
                    {% endif %}
                </select>
                <input type="search" class="search-input" placeholder="Search...">
                <div class="select-options">
                    {% for account in head_accounts %}
                        <div data-value="{{ account.account_code }}">{{ account.head }}</div>
                    {% endfor %}
                    {% if entry.accountcode not in valid_account_codes %}
                        <div data-value="{{ entry.accountcode }}">{{ entry.accountcode }}</div>
                    {% endif %}
                </div>
            </div>
        </td>
        <td><input style="width: 300px" type="text" name="narration[]" value="{{ entry.narration }}" ></td>
        <td><input style="width: 100px" type="number" name="dramount[]" value="{{ entry.dramount }}" step="0.01" ></td>
        <td><input style="width: 100px" type="number" name="cramount[]" value="{{ entry.cramount }}" step="0.01" onkeydown="checkEnter(event)" ></td>
        <td style="text-align: center;"><button type="button" class="removeRowBtn" title="Non Remove" onclick="removeRow(this)">  <i class="fas fa-trash-alt"></i></button></td>
    `;
    tableBody.appendChild(newRow);

    initializeSelectContainers(); // Reapply search functionality to new rows
}



function removeRow(button) {
    const row = button.closest('tr');
    row.classList.add('slide-out');
    setTimeout(() => {
        row.remove();
        updateRowNumbers(); // Update row numbers after removal
    }, 500);
}

function updateRowNumbers() {
    const rows = document.querySelectorAll('#dynamicRows tr');
    rows.forEach((row, index) => {
        row.querySelector('input[name="SlNo[]"]').value = index + 1;
    });
}


    function removeRow(button) {
        // Remove the row from the table
        const row = button.closest('tr');
        row.remove();

        // Update the serial numbers
        const rows = document.querySelectorAll('#dynamicRows tr');
        rows.forEach((row, index) => {
            row.querySelector('input[name="SlNo[]"]').value = index + 1;
        });
    }

        // JavaScript function to handle row removal with slide-out effect
        function removeRow(button) {
        const row = button.closest('tr');
        row.classList.add('slide-out');
        setTimeout(() => {
            row.remove();
            updateRowNumbers(); // Update row numbers after removal
        }, 500);
    }
</script>



<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        updateCreditAndTotal(); // Initial calculation

        // Add event listeners for input changes
        document.getElementById('dynamicTable').addEventListener('input', updateCreditAndTotal);
    });

    function updateCreditAndTotal() {
        let totalDebit = 0;
        let totalCredit = 0;

        const debitInputs = document.querySelectorAll('input[name="dramount[]"]');
        const creditInputs = document.querySelectorAll('input[name="cramount[]"]');

        debitInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            totalDebit += value;
        });

        creditInputs.forEach(input => {
            const value = parseFloat(input.value) || 0;
            totalCredit += value;
        });

        document.getElementById('total_amount').value = totalDebit.toFixed(2);
        document.getElementById('total_amount2').value = totalCredit.toFixed(2);
    }

    function handleSubmit(event) {
        event.preventDefault();

        const totalAmount = parseFloat(document.getElementById('total_amount').value) || 0;
        const totalAmount2 = parseFloat(document.getElementById('total_amount2').value) || 0;

        if (totalAmount !== totalAmount2) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'The Debit and Credit totals do not match. Please correct the amounts.'
            });
            return;
        }

        const form = event.target;
        const series = document.getElementById('series').value;
        const vdate = document.getElementById('date').value;

        if (!series || !vdate) {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Please fill out all required fields.'
            });
            return;
        }

        // Show confirmation dialog
        Swal.fire({
            title: 'Confirm Submission',
            text: "Are you sure you want to submit the form?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, submit it!'
        }).then((result) => {
            if (result.isConfirmed) {
                form.submit();
            }
        });
    }
</script>

<script>
    document.addEventListener('DOMContentLoaded', (event) => {
        const accountHeadMap = {
            {% for account in head_accounts %}
                "{{ account.account_code }}": "{{ account.head }}",
            {% endfor %}
        };

        const headSelectElements = document.querySelectorAll('select[name="head"]');
        
        headSelectElements.forEach(selectElement => {
            const selectedValue = selectElement.value;
            if (selectedValue in accountHeadMap) {
                selectElement.options[selectElement.selectedIndex].text = accountHeadMap[selectedValue];
            }
        });
    });
</script>



<script>
    function confirmDelete(voucher_no) {
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`{% url 'main:delete_journal_entry' 0 %}`.replace('0', voucher_no), {
                    method: 'DELETE',
                    headers: {
                        'X-CSRFToken': '{{ csrf_token }}',
                        'Content-Type': 'application/json'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        Swal.fire(
                            'Deleted!',
                            'Journal entry has been deleted.',
                            'success'
                        ).then(() => {
                            window.location.href = "{% url 'main:account_journal_table' %}";
                        });
                    } else {
                        Swal.fire(
                            'Error!',
                            'Something went wrong.',
                            'error'
                        );
                    }
                });
            }
        });
    }
</script>

<script>
    function removeRow(button) {
    const row = button.closest('tr');
    
    Swal.fire({
        title: 'Are you sure?',
        text: "Do you want to remove this row?",
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, remove it!',
        cancelButtonText: 'No, cancel!'
    }).then((result) => {
        if (result.isConfirmed) {
            row.classList.add('slide-out');
            setTimeout(() => {
                row.remove();
                updateRowNumbers(); // Update row numbers after removal
            }, 500);
            
            // Swal.fire(
            //     'Removed!',
            //     'The row has been removed.',
            //     'success'
            // );
        }
    });
}

</script>


<script>
    $(document).ready(function() {
        $('#account-head-select').select2({
            placeholder: 'Select an account',
            allowClear: true
        });
    });
    </script>
    

    <script>
        document.querySelectorAll('.select-container').forEach(container => {
            const selectElement = container.querySelector('.account-head-select');
            const searchInput = container.querySelector('.search-input');
            const optionsContainer = container.querySelector('.select-options');
            const options = Array.from(optionsContainer.querySelectorAll('div'));
    
            selectElement.addEventListener('click', function() {
                searchInput.classList.add('active');
                searchInput.focus();
                optionsContainer.style.display = 'block';
            });
    
            searchInput.addEventListener('input', function() {
                const searchValue = searchInput.value.toLowerCase();
                options.forEach(option => {
                    const text = option.textContent.toLowerCase();
                    option.style.display = text.includes(searchValue) ? 'block' : 'none';
                });
            });
    
            options.forEach(option => {
                option.addEventListener('click', function() {
                    selectElement.value = this.getAttribute('data-value');
                    selectElement.dispatchEvent(new Event('change')); // Trigger change event
                    selectElement.querySelector(`option[value="${this.getAttribute('data-value')}"]`).selected = true;
                    searchInput.classList.remove('active');
                    optionsContainer.style.display = 'none';
                });
            });
        });
    
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.select-container')) {
                document.querySelectorAll('.search-input.active').forEach(input => {
                    input.classList.remove('active');
                });
                document.querySelectorAll('.select-options').forEach(options => {
                    options.style.display = 'none';
                });
            }
        });
    </script>





{% endblock %}
