{% extends "base.html" %}
{% load static %}
{% block content %}
<link rel="stylesheet" href="{% static 'css/receipt.css' %}">
<link rel="stylesheet" href="{% static 'js/search.js' %}">
<link rel="stylesheet" href="{% static 'css/style.css' %}" />
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<style>
    .search-dropdown-container {
        position: relative;
        width: 100%;
    }
    
    .newinput {
        width: 100%;
        box-sizing: border-box;
        padding: 8px;
        margin-bottom: 5px;
    }
    
    .dropdown-menu {
        position: absolute;
        width: 100%;
        border: 1px solid #ccc;
        border-top: none;
        background-color: white;
        max-height: 150px;
        overflow-y: auto;
        z-index: 1000;
        display: none; /* Initially hidden */
    }
    
    .dropdown-item {
        padding: 8px;
        cursor: pointer;
        text-align: left;
    }
    
    .dropdown-item:hover {
        background-color: #f0f0f0;
    }
    .bx-minus {
        color: red;
    }
  </style>
<div class="group-data-[sidebar-size=lg]:ltr:md:ml-vertical-menu group-data-[sidebar-size=lg]:rtl:md:mr-vertical-menu group-data-[sidebar-size=md]:ltr:ml-vertical-menu-md group-data-[sidebar-size=md]:rtl:mr-vertical-menu-md group-data-[sidebar-size=sm]:ltr:ml-vertical-menu-sm group-data-[sidebar-size=sm]:rtl:mr-vertical-menu-sm pt-[calc(theme('spacing.header')_*_1)] pb-[calc(theme('spacing.header')_*_0.8)] px-4 group-data-[navbar=bordered]:pt-[calc(theme('spacing.header')_*_1.3)] group-data-[navbar=hidden]:pt-0 group-data-[layout=horizontal]:mx-auto group-data-[layout=horizontal]:max-w-screen-2xl group-data-[layout=horizontal]:px-0 group-data-[layout=horizontal]:group-data-[sidebar-size=lg]:ltr:md:ml-auto group-data-[layout=horizontal]:group-data-[sidebar-size=lg]:rtl:md:mr-auto group-data-[layout=horizontal]:md:pt-[calc(theme('spacing.header')_*_1.6)] group-data-[layout=horizontal]:px-3 group-data-[layout=horizontal]:group-data-[navbar=hidden]:pt-[calc(theme('spacing.header')_*_0.9)]">
    <div class="container-fluid group-data-[content=boxed]:max-w-boxed mx-auto">
<div class="container-fluid">
    <h4 class="py-5"></h4>
    <div class="center">
        <h2>Edit Payment Voucher</h2>
        <h4 class="py-5"></h4>

        <form method="post" action="{% url 'main:edit_payment' %}" class="mb-5" id="editPaymentForm" onsubmit="handleSubmit(event)">
            {% csrf_token %}
            <input type="hidden" name="edit" value="true">
            <input type="hidden" name="VoucherNo" value="{{ voucher_entries.0.VoucherNo }}">
            <input type="hidden" name="Series" value="{{ voucher_entries.0.Series }}">

            <div class="firstdiv">
                <div class="series">
                    <label for="Series">Series</label>
                    <select name="Series" id="series" onchange="updateSerialNo()" disabled>
                        <option value="{{ voucher_entries.0.Series }}" selected>{{ voucher_entries.0.Series }}</option>
                    </select>
                </div>
                <div class="firstdivright">
                    <label for="Headcode">Book Head</label>
                    <select name="table_acntchild" id="table_acntchild" onchange="displayAccountDetails(this)" required>
                        <option value="" disabled>Select</option>
                        {% for child in table_acntchildren %}
                            <option value="{{ child.account_master.head }}" data-account-code="{{ child.account_code }}" data-current-balance="{{ child.current_balance }}" {% if child.account_master.head == voucher_entries.0.Headcode %}selected{% endif %}>{{ child.account_master.head }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>
            <br>
            <div class="secondediv grid-container">
                <div class="grid-item">
                    <label for="VoucherNo">Payment Voucher No</label>
                    <input type="text" name="VoucherNo" style="width: 40%;" id="serial_no" readonly value="{{ voucher_entries.0.VoucherNo }}">
                </div>
                <div class="date grid-item">
                    <label for="Vdate" style="padding-top: 5px;">Date : &nbsp</label>
                    <input style="width: 50%; margin: 0;" type="date" class="newinput" name="Vdate" id="date" value="{{ voucher_entries.0.Vdate|date:'Y-m-d' }}" required>
                </div>
                <div class="secndedivright grid-item">
                    <label for="Headcode">Book Code</label>
                    <input type="text" name="Headcode" id="account_code" readonly value="{{ voucher_entries.0.Headcode }}">
                </div>
            </div>
            <br>  
            <div class="grid-item" style="justify-content: end;">
                <label for="current_balance">Current Balance</label>
                <input type="text" name="current_balance" id="current_balance" style="width: 16.7%;" readonly value="{{ voucher_entries.0.current_balance }}">
            </div>
            <br>
            <table id="dynamicTable" style="background-color: white !important;">
                <thead>
                    <tr>
                        <th>Sl No</th>
                        <th>Head</th>
                        <th>Narration</th>  
                        <th>Cash/RTGS.</th>
                        <th>Amount</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="dynamicRows">
                    {% for entry in voucher_entries %}
                        <tr class="py-1">
                            <td style="width:10px;" ><input type="text" style="margin-left: 0px;" name="SlNo[]" value="{{ forloop.counter }}" readonly></td>
                            <td>
                                <div class="search-dropdown-container">
                                    <input type="text" class="newinput" placeholder="Search head..." onkeyup="filterOptions(this)" data-row-index="{{ forloop.counter0 }}" value="{{ entry.Accountcode }}">
                                    <input type="hidden" name="Accountcode[]" class="selectedAccountCode" value="{{ entry.Accountcode }}">
                                    <div class="dropdown-menu">
                                        {% for account in head_accounts %}
                                        <div class="dropdown-item" data-value="{{ account.account_code }}">{{ account.head }}</div>
                                        {% endfor %}
                                    </div>
                                </div>
                            </td>
                            <td><input type="text" class="newinput" name="Narration[]" value="{{ entry.Narration }}" ></td>
                            <td style="width:13%;">
                                <select name="VType[]" class="newinput" required>
                                    <option value="Cash" {% if entry.VType == 'Cash' %}selected{% endif %}>Cash</option>
                                    <option value="G-PAY" {% if entry.VType == 'G-PAY' %}selected{% endif %}>G-PAY</option>
                                    <option value="RTGS" {% if entry.VType == 'RTGS' %}selected{% endif %}>RTGS</option>
                                </select>
                            </td>
                            <td style="width:10%;"><input type="number" class="newinput" onkeydown="checkEnter(event)" oninput="updateTotalAmount()" name="payment[]" value="{{ entry.payment }}" step="0.01" required></td>
                            <td><button type="button" onclick="removeRow(this)"><i class='bx bx-minus'></i></button></td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            <br>
            <div class="lastdiv">
              <div class="series">
              </div>
              <div class="lastdivright">
                <label for="VAmount">Total Amount</label>
                <input style="width: 150px;" type="text" name="VAmount" id="total_amount" readonly>
              </div>
            </div>
            <br>
            <br>
            <div class="box btns" style="display: flex; justify-content: center;">

            <button type="submit" class="addbutton"><i class='bx bx-plus-medical'></i>Submit</button>
            <a href="{% url 'main:payment_modify' %}"><button type="button" class="exitbutton"><i class='bx bx-arrow-back'></i> Back</button></a>
            <button type="button" id="delete-btn" class="exitbutton"><i class='bx bx-trash'></i> Delete</button>
        </div>

        </form>
    </div>
</div>
</div>
</div>
<script>
    let isAddingRow = false; // Flag to prevent adding multiple rows

    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.search-dropdown-container').forEach(container => {
            const input = container.querySelector('input[type="text"]');
            const dropdown = container.querySelector('.dropdown-menu');
            const selectedAccountCode = container.querySelector('.selectedAccountCode').value;
    
            const items = dropdown.getElementsByClassName('dropdown-item');
            Array.from(items).forEach(item => {
                if (item.getAttribute('data-value') === selectedAccountCode) {
                    input.value = item.textContent;
                }
            });
        });
    });
    
    function filterOptions(input) {
        const container = input.closest('.search-dropdown-container');
        const filter = input.value.toLowerCase();
        const dropdown = container.querySelector('.dropdown-menu');
        const items = dropdown.getElementsByClassName('dropdown-item');
        
        let hasVisibleItems = false;
    
        for (let i = 0; i < items.length; i++) {
            const item = items[i];
            const txtValue = item.textContent || item.innerText;
            
            if (txtValue.toLowerCase().indexOf(filter) > -1) {
                item.style.display = '';
                hasVisibleItems = true;
            } else {
                item.style.display = 'none';
            }
        }
        
        dropdown.style.display = hasVisibleItems ? 'block' : 'none';
    }
    
    // Handle item selection
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.search-dropdown-container').forEach(container => {
            const input = container.querySelector('.newinput');
            const dropdown = container.querySelector('.dropdown-menu');
            const selectedAccountCode = container.querySelector('.selectedAccountCode');
            
            // Handle keyup event to filter options
            input.addEventListener('keyup', function() {
                filterOptions(input);
            });
    
            // Handle click event to select an item
            dropdown.addEventListener('click', function(event) {
                if (event.target.classList.contains('dropdown-item')) {
                    const selectedCode = event.target.getAttribute('data-value');
                    const selectedText = event.target.textContent;
    
                    input.value = selectedText;
                    selectedAccountCode.value = selectedCode;
    
                    dropdown.style.display = 'none';
                }
            });
    
            // Close dropdown if clicked outside
            document.addEventListener('click', function(event) {
                if (!container.contains(event.target)) {
                    dropdown.style.display = 'none';
                }
            });
        });
    });

    function checkEnter(event) {
        if (event.key === 'Enter' && !isAddingRow) {
          isAddingRow = true; // Set the flag to true to prevent adding multiple rows
          event.preventDefault();
          addRow();
        }
      }
    
    function addRow() {
      const tableBody = document.getElementById('dynamicTable').getElementsByTagName('tbody')[0];
      const newRow = tableBody.insertRow();
      const rowCount = tableBody.rows.length;

      newRow.innerHTML = `
        <td>${rowCount}</td>
        <td>
          <div class="search-dropdown-container">
            <input type="text" class="newinput" placeholder="Search head..." onkeyup="filterOptions(this)">
            <input type="hidden" name="Accountcode[]" class="selectedAccountCode">
            <div class="dropdown-menu">
              {% for account in head_accounts %}
              <div class="dropdown-item" data-value="{{ account.account_code }}">{{ account.head }}</div>
              {% endfor %}
            </div>
          </div>
        </td>
        <td><input type="text" class="newinput" name="Narration[]"></td>
        <td style="width:13%;">
          <select name="VType[]" class="newinput" onchange="toggleChequeFields(this)">
            <option value="CASH">CASH</option>
            <option value="RTGS">RTGS</option>
            <option value="G-PAY">G-PAY</option>
          </select>
        </td>
        <td style="width:10%;">
          <input type="text" name="payment[]" step="0.01" onkeydown="checkEnter(event)" oninput="updateTotalAmount()" class="newinput" required>
        </td>
        <td><button type="button" onclick="removeRow(this)"><i class='bx bx-minus'></i></button></td>
      `;

      document.querySelectorAll('.dropdown-item').forEach(item => {
        item.addEventListener('click', function() {
          const container = this.closest('.search-dropdown-container');
          const input = container.querySelector('.newinput');
          const hiddenInput = container.querySelector('.selectedAccountCode');
          input.value = this.textContent;
          hiddenInput.value = this.getAttribute('data-value');
          container.querySelector('.dropdown-menu').style.display = 'none';
        });
      });

      isAddingRow = false; // Reset the flag to false
    }

    function removeRow(button) {
        Swal.fire({
          title: 'Are you sure?',
          text: 'Do you really want to delete this row?',
          icon: 'warning',
          showCancelButton: true,
          confirmButtonText: 'Yes, delete it!',
          cancelButtonText: 'No, cancel!',
          reverseButtons: true
        }).then((result) => {
          if (result.isConfirmed) {
            // Remove the row if 'Yes' is clicked
            const row = button.closest('tr');
            row.remove();
            updateTotalAmount(); // Recalculate the total amount after a row is removed
            Swal.fire(
              'Deleted!',
              'The row has been deleted.',
              'success'
            );
          } else if (result.dismiss === Swal.DismissReason.cancel) {
            Swal.fire(
              'Cancelled',
              'The row is safe :)',
              'error'
            );
          }
        });
    }
    function updateTotalAmount() {
        const tableBody = document.getElementById('dynamicTable').getElementsByTagName('tbody')[0];
        let totalAmount = 0;
    
        for (let row of tableBody.rows) {
          const paymentInput = row.querySelector('input[name="payment[]"]');
          totalAmount += parseFloat(paymentInput.value) || 0;
        }
    
        document.getElementById('total_amount').value = totalAmount.toFixed(2);
      }

      document.getElementById('delete-btn').addEventListener('click', function() {
        Swal.fire({
            title: 'Are you sure?',
            text: "You won't be able to revert this!",
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#3085d6',
            cancelButtonColor: '#d33',
            confirmButtonText: 'Yes, delete it!',
            cancelButtonText: 'No, cancel!'
        }).then((result) => {
            if (result.isConfirmed) {
                // Perform the delete operation
                fetch("{% url 'main:edit_payment' %}", {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-CSRFToken': '{{ csrf_token }}'
                    },
                    body: new URLSearchParams({
                        'action': 'delete',  // Indicate a delete action
                        'Series': '{{ voucher_entries.first.Series }}',
                        'VoucherNo': '{{ voucher_entries.first.VoucherNo }}'
                    })
                }).then(response => {
                    if (response.ok) {
                        window.location.href = "{% url 'main:payment' %}"; // Redirect to the payment page
                    } else {
                        Swal.fire('Error', 'Failed to delete the payment.', 'error');
                    }
                });
            }
        });
    });
    function handleSubmit(event) {
        event.preventDefault(); // Prevent the default form submission
    
        Swal.fire({
            title: 'Are you sure?',
            text: "Do you want to save the changes?",
            icon: 'question',
            showCancelButton: true,
            confirmButtonText: 'Yes, save it!',
            cancelButtonText: 'No, cancel',
            reverseButtons: true
        }).then((result) => {
            if (result.isConfirmed) {
                console.log('Form submission confirmed. Submitting form now.');
    
                // Check if the form exists and then submit it
                const form = document.getElementById('editPaymentForm');
                if (form) {
                    form.submit();
                } else {
                    console.error('Form not found.');
                }
            } else if (result.dismiss === Swal.DismissReason.cancel) {
                Swal.fire(
                    'Cancelled',
                    'Your changes were not saved.',
                    'error'
                );
            }
        });
    }
</script>
{% endblock %}
