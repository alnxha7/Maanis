{% extends "base.html" %}
{% load static %}
{% block content %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Detils</title>

    <link href="{% static 'css/font-face.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/font-awesome-4.7/css/font-awesome.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/font-awesome-5/css/fontawesome-all.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/mdi-font/css/material-design-iconic-font.min.css' %}" rel="stylesheet" media="all">

    <!-- Bootstrap CSS-->
    <link href="{% static 'vendor/bootstrap-4.1/bootstrap.min.css' %}" rel="stylesheet" media="all">

    <!-- Vendor CSS-->
    <link href="{% static 'vendor/animsition/animsition.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/bootstrap-progressbar/bootstrap-progressbar-3.3.4.min.css' %}" rel="stylesheet"
          media="all">
    <link href="{% static 'vendor/wow/animate.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/css-hamburgers/hamburgers.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/slick/slick.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/select2/select2.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/perfect-scrollbar/perfect-scrollbar.css' %}" rel="stylesheet" media="all">

    <!-- Main CSS-->
    <link href="{% static 'css/theme.css' %}" rel="stylesheet" media="all">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    @media print {
        body {
            width: 210mm;
            height: 297mm;
            margin: 0;
            padding: 0;
        }
        table {
            width: 100%;
        }
        #print-button {
            display: none;
        }
    }
        .form-control {
        padding: 2px 8px;
        font-size: 14px;
    }
    .mb-3, .mb-2 {
        margin-bottom: 8px !important;
        align-items: center;
    }
     body {
            font-family: Public Sans, sans-serif;
            background-color: #f4f4f4;

            margin: 0;
            padding: 0;
            font-size: 14px;
            align-items: center;
            color:black;

        }
         .logo p {
        color:white;
        }
        .container_box {
            background-color:antiquewhite;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border: 2px solid rgb(43, 114, 227);
            margin-left:20px;
            margin-top:100px;
        }


        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        label {

            margin-bottom: 5px;
        }

        
        input, select {
            width: 100%;
            font-size: 10px;
        }
        select {
        background:white;
        

        }
        table {
            background:white;
            border-collapse: collapse;
            margin-top: 20px;
            margin-bottom:20px;
        }
        .table_input{
            border:none;
        }
        th {
            border: 1px solid black;
            background:#f2f2f2;
            padding:5px;
            text-align: center;
            font-size: 12px;
        }
        button {
            padding: 10px;
            background: #28a745;
            border: none;
            color: white;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background: #218838;
        }
        .btn {
            margin-top: -10px;
            display: inline-block;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 4px;
            color: white;
            margin-right:10px;
            margin-bottom:20px;
        }

        .btn-info{
            margin-top: -25px;
            display: inline-block;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 4px;
            color: white;
            margin-right:10px;
            margin-bottom:-15px; 
        }

        .save-btn { background-color: #28a745; }
        .back-btn { background-color: #007bff; }

        .input-right {
            text-align: right;
        }
    @media only screen and (max-width: 600px) {
  .container_box  {
    width: 90%;
  }
}
    label {
        font-weight: 500;
        width: 90px;
        font-size: 12px;
    }
    .form-group-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    .form-group-row label {
        min-width: 120px;
        margin-right: 8px;
        margin-bottom: 0;
    }
    /* .table-container {
            margin-top: 20px;
            overflow-x: auto;
        } */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th {
            border: 1px solid #999;
            padding: 2px;
            text-align: center;
        }
        td {
            border: 1px solid #999;
            padding: -4px;
            text-align: center;
            font-size: 11px;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="text"], input[type="number"] {
            /* width: 100%; */
            padding: -5px;
            box-sizing: border-box;
        }
        .btn-delete {
            color: white;
            border: none;
            padding: 0px 5px;
            cursor: pointer;
        }
        .btn-delete:hover {
            background-color: #c0392b;
        }
        .table_data {
            font-size: 12px;
            padding: 2px 4px;
            text-align: center;
            width: 70px; /* set a fixed width */
            max-width: 80px; /* prevent stretching */
            box-sizing: border-box;
        }
    .top-section {
        width: 210%;
        padding-left: 20px;
        padding-right: 340px;
    }



    .bottom-section {
    display: flex;
    justify-content: space-between;
    gap: 20px;
}

.column {
    padding: 2px;
    border-radius: 6px;
   /* box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);*/
}

/* Widths to control layout */
/* .first-column {
    flex: 1; 
} */

.second-column {
    flex: 0.5; /* Center - less space */
    text-align: left;
}

.third-column {
    padding-left: 10px;
}

/* Optional: Ensure inputs are consistent */
.column input {
    width: 100%;
    font-size: 12px;
    margin-bottom: 8px;
}

/* Make labels a little smaller for alignment */
.column label {
    display: block;
    margin-bottom: 4px;
    font-size: 13px;
}
.d-flex.align-items-center {
    gap: 4px; /* Reduce space between label and input */
}

.d-flex.align-items-center > div {
    margin-bottom: 0;
    flex: 0 0 auto; /* Prevent stretching */
    padding-right: 4px; /* Small spacing */
}

.d-flex.align-items-center label {
    margin-bottom: 0;
    font-size: 12px; /* Optional: reduce font size */
    white-space: nowrap; /* Keep label on one line */
}

.d-flex.align-items-center input {
    flex: 1; /* Let input take remaining space */
    max-width: 150px; 
    font-size: 13px;
}


/* --------------------------- INVOICE STYLE ----------------------------- */

@media print {
    body * {
        visibility: hidden;
    }
    #print-invoice, #print-invoice * {
        visibility: visible;
    }
    #print-invoice {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
}

/* --------------------------- INVOICE STYLE END ----------------------------- */
    </style>

 <div class="container_box">

 <div class="container">


<h2>Bill Details</h2>

<form method="post" action="{% url 'main:bill_details' %}" id="bill-form">
    {% csrf_token %}
    <div class="container">
        <!-- ?? Top Section -->
        {% if prefill %}
        <div class="top-section">     
            <div class="form-group row">
                <label for="series" class="">Series</label>
                <div class="col-sm-1">
                    <select name="series" id="series" class="form-control" required style="padding: 3px 6px; font-size: 13px; height: 30px;">
                        <option value="">Select series</option>
                        {% for voucher in vouchers %}
                            <option value="{{ voucher.id }}" {% if series|default:'' == voucher.id|stringformat:"s" %}selected{% endif %}>
                                {{ voucher.series }}
                            </option>
                        {% endfor %}
                    </select>
                </div>

                <label for="entry_number" class="">Bill Number</label>
                <div class="col-sm-1">
                    <input type="text" name="entry_number" id="entry_number" value="{{ entry_number }}" class="form-control" readonly required>
                </div>

                <label for="bill_date" class="">Bill Date</label>
                <div class="col-sm-1">
                    <input type="date" name="bill_date" id="bill_date" class="form-control" value="{{ bill_date|default:today_date }}" required>
                </div>

                <label for="bill_date" style="margin-left: 10px;">GST Type</label>
                <div class="">
                    <select name="gst_type" id="gst_type" class="form-control" required style="width: 72px; font-size: 13px; height: 30px;">
                        <option value="gst" {% if gst_type == 'gst' %}selected{% endif %}>GST</option>
                        <option value="igst" {% if gst_type == 'igst' %}selected{% endif %}>IGST</option>
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <label for="bill_type" class="">Bill Type</label>
                <div class="col-sm-1">
                    <select name="bill_type" id="bill_type" class="form-control" required style="padding: 3px 6px; font-size: 13px; height: 30px;">
                        <option value="Cash">Cash</option>
                        <option value="Credit">Credit</option>
                    </select>
                </div>

                <label for="customer_id" class="">Customer ID</label>
                <div class="col-sm-1">
                    <input type="text" name="customer_id" id="customer_id" class="form-control" value="{{ customer_id }}" required readonly>
                </div>

                <label for="customer_name" class="">Customer Name</label>
                <div class="col-sm-1">
                    <input type="text" name="customer_name" id="customer_name" class="form-control" value="{{ customer_name }}" style="width: 310px;" required autocomplete="off">
                    <div id="customerList" class="autocomplete-items" style="position: absolute; z-index: 1000;"></div>
                </div>
            </div>

            <div class="form-group row">
                <label for="address" class="">Address</label>
                <div class="col-sm-1">
                    <input type="text" name="address" id="address" value="{{ address}}" class="form-control">
                </div>

                <label for="gst" class="">GSTIN</label>
                <div class="col-sm-1">
                    <input type="text" name="gst" id="gst" value="{{ gst }}" class="form-control">
                </div>

                <label for="from_date">Date From</label>
                <div class="col-sm-1">
                    <input type="date" name="from_date" id="from_date" class="form-control" value="{{ from_date|default:today_date }}" required>
                </div>

                <label style="width: 42px; margin-left: 7px;" for="to_date" class="">Date To</label>
                <div class="col-sm-1">
                    <input type="date" name="to_date" id="to_date" class="form-control" value="{{ to_date|default:today_date }}" required>
                </div>
            </div>


            <div class="form-group row">
                <label for="rate_type" class="">Rate Type</label>
                <div class="col-sm-1">
                    <select name="rate_type" id="rate_type" class="form-control" required style="padding: 3px 6px; font-size: 13px; height: 30px;">
                        <option value="Km Wise" {% if rate_type == "Km Wise" %}selected{% endif %}>Km Wise</option>
                        <option value="Fixed" {% if rate_type == "Fixed" %}selected{% endif %}>Fixed</option>
                        <option value="Monthly" {% if rate_type == "Monthly" %}selected{% endif %}>Monthly</option>
                    </select>
                </div>

                <div class="col-sm-1 offset">
                    <button type="submit" id="" class="btn btn-info" name="action" value="go"
                     style="width: 47px; height: 28px; padding: 0px 0px 0px 0px; margin: 0px 0px 0px 0px;">
                        Go
                    </button>
                </div>
            </div>
        </div>
        {% else %}
        <div class="top-section">
               
            <div class="form-group row">
                <label for="series" class="">Series</label>
                <div class="col-sm-1">
                    <select name="series" id="series" class="form-control" required style="padding: 3px 6px; font-size: 13px; height: 30px;">
                        <option value="">Select series</option>
                        {% for voucher in vouchers %}
                            <option value="{{ voucher.id }}">{{ voucher.series }}</option>
                        {% endfor %}
                    </select>
                </div>

                <label for="entry_number" class="">Bill Number</label>
                <div class="col-sm-1">
                    <input type="text" name="entry_number" id="entry_number" class="form-control" readonly required>
                </div>

                <label for="bill_date" class="">Bill Date</label>
                <div class="col-sm-1">
                    <input type="date" name="bill_date" id="bill_date" class="form-control" value="{% now 'Y-m-d' %}" required>
                </div>

                <label for="bill_date" style="margin-left: 17px;">GST Type</label>
                <div class="">
                    <select name="gst_type" id="gst_type" class="form-control" required style="width: 72px; font-size: 13px; height: 30px;">
                        <option value="gst">GST</option>
                        <option value="igst">IGST</option>
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <label for="bill_type" class="">Bill Type</label>
                <div class="col-sm-1">
                    <select name="bill_type" id="bill_type" class="form-control" required style="padding: 3px 6px; font-size: 13px; height: 30px;">
                        <option value="Cash" {% if first_trip.bill_type == "Cash" %}selected{% endif %}>Cash</option>
                        <option value="UPI" {% if first_trip.bill_type == "Credit" %}selected{% endif %}>Credit</option>
                    </select>
                </div>

                <label for="customer_id" class="">Customer ID</label>
                <div class="col-sm-1">
                    <input type="text" name="customer_id" id="customer_id" class="form-control" required readonly>
                </div>

                <label for="customer_name" class="">Customer Name</label>
                <div class="col-sm-1">
                    <input type="text" name="customer_name" id="customer_name" class="form-control" style="width: 310px;" required autocomplete="off">
                    <div id="customerList" class="autocomplete-items" style="position: absolute; z-index: 1000;"></div>
                </div>
            </div>

            <div class="form-group row">
                <label for="address" class="">Address</label>
                <div class="col-sm-1">
                    <input type="text" name="address" id="address" class="form-control">
                </div>

                <label for="gst" class="">GSTIN</label>
                <div class="col-sm-1">
                    <input type="text" name="gst" id="gst" class="form-control">
                </div>

                <label for="from_date">Date From</label>
                <div class="col-sm-1">
                    <input type="date" name="from_date" id="from_date" class="form-control" value="{% now 'Y-m-d' %}"  required>
                </div>

                <label style="width: 42px; margin-left: 7px;" for="to_date" class="">Date To</label>
                <div class="col-sm-1">
                    <input type="date" name="to_date" id="to_date" class="form-control" value="{% now 'Y-m-d' %}"  required>
                </div>
            </div>


            <div class="form-group row">
                <label for="rate_type" class="">Rate Type</label>
                <div class="col-sm-1">
                    <select name="rate_type" id="rate_type" class="form-control" required style="padding: 3px 6px; font-size: 13px; height: 30px;">
                        <option value="Km Wise">Km Wise</option>
                        <option value="Fixed">Fixed</option>
                        <option value="Monthly">Monthly</option>
                    </select>
                </div>

                <div class="col-sm-1 offset">
                    <button type="submit" id="" class="btn btn-info" name="action" value="go" 
                    style="width: 47px; height: 28px; padding: 0px 0px 0px 0px; margin: 0px 0px 0px 0px;">
                        Go
                    </button>
                </div>
            </div>
        </div>
        {% endif %}
        <!-- ?? Table Section -->
        <div class="table-container">
            <table id="tripTable">
                <thead>
                    <tr>
                        <th>Sl.no</th>
                        <th>Code</th>
                        <th>Vehicle No:</th>
                        <th>Vehicle Type</th>
                        <th>Total KM</th>
                        <th>KM Rate</th>
                        <th>E.Hr.Rate</th>
                        <th>Fixed</th>
                        <th>Toll Parking</th>
                        <th>Haulting</th>
                        <th>M. Fixed</th>
                        <th>Gross Amount</th>
                        <th>Tax %</th>
                        <th style="background-color: gray;color: white;">Net Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% if trips %}
                        {% for trip in trips %}
                                <input type="hidden" name="trip_id[]" value="{{ trip.id }}">
                                <tr>
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ trip.entry_number }}</td>
                                    <td>{{ trip.vehicle_number_id.registration_number }}</td>
                                    <td>{{ trip.vehicle_type_id.vehicle_name }}</td>
                                    <td>{{ trip.total_km }}</td>
                                    <td><input type="number" class="table_data" name="km_rate_{{trip.id}}" value="{{ trip.km_charge_total|default_if_none:'0.00' }}"></td>
                                    <td><input type="number" class="table_data" name="extra_hour_rate_{{ trip.id }}" value="{{ trip.extra_hour_charge_total|default_if_none:'0.00' }}"></td>
                                    <td class="fixed-charge" id="fixed_charge_{{ trip.id }}">{{ trip.fixed_charge_total }}</td>
                                    <td><input type="number" class="table_data" name="toll_parking_{{ trip.id }}" value="{{ trip.toll_parking_total|default_if_none:'0.00' }}"></td>
                                    <td><input type="number" class="table_data" name="haulting_{{ trip.id }}" value="{{ trip.haulting_charge_total|default_if_none:'0.00' }}"></td>
                                    <td>0.00</td>
                                    <td>{{ trip.total_freight_charges|default_if_none:'0.00' }}</td>
                                    <td>{{ trip.customer_name.tax }}</td>
                                    <td class="net_value freight-value" style="background-color: gray; color: white;">{{ trip.total_freight_charges }}</td>
                                    <input type="hidden" name="net_values[]" class="net_value_input">
                                    <input type="hidden" name="freight_charges[]" class="freight_charges_input" value="{{ trip.total_freight_charges|default_if_none:'0.00' }}">
                                </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="12" style="text-align: center;">No trips found for the selected criteria.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- ?? Expense Details Section -->
        <div class="row mt-4"></div>

        <div class="bottom-section">

            <div class="column first-column">
                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px; padding-left: 0px;">
                <label for="sp_disc_percent" class="">Sp. Disc (%)</label>
                </div>
                <!-- <div class="col-sm-2"> -->
                    <input type="number" class="form-control" name="sp_disc_percent" id="sp_disc_percent" value="0.00" step="0.1">
                </div>

                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px; padding-left: 0px;">
                <label for="sp_disc_amt" class="">Sp. Disc (Amt)</label>
            </div>
                <!-- <div class="col-sm-2"> -->
                    <input type="number" class="form-control" name="sp_disc_amt" id="sp_disc_amt" value="0.00" step="0.1">
                </div>

                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px; padding-left: 0px;">
                <label for="round_off" class="">Round Off</label>
            </div>
                <!-- <div class="col-sm-2"> -->
                    <input type="number" class="form-control" name="round_off" id="round_off" step="0.1" readonly>
                </div>
            </div>

            <div class="column second-column">
                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px;">
                <label for="total_km" class="">Total KM</label>
                <!-- <div class="col-sm-2"> -->
                    </div>
                    <input type="number" class="form-control" name="total_km" value="0.00" step="0.1" id="total_km" readonly>
                </div>

                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px;">
                <label for="total_gross" class="">Total Gross</label>
                <!-- <div class="col-sm-2"> -->
                    </div>
                    <input type="number" class="form-control" name="total_gross" id="total_gross" readonly>
                </div>

                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px;">
                <label for="total_discounts" class="">Total Discounts</label>
                <!-- <div class="col-sm-2"> -->
                    </div>
                    <input type="number" class="form-control" name="total_discounts" id="total_discounts" value="0.00" step="0.01" readonly>
                </div>

                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px;">
                <label for="additional_charges" class="" style="white-space: inherit;">Extra Km Charges</label>
                <!-- <div class="col-sm-2"> -->
                    </div>
                    <input type="number" class="form-control" name="additional_charges" id="additional_charges" value="0.00" step="0.01" readonly>
                </div>
            </div>

            <div class="column third-column">
                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px;">
                <label for="net_total" class="">Amt Before Tax</label>
                <!-- <div class="col-sm-2"> -->
                    </div>
                    <input type="number" class="form-control" name="net_total" id="net_total" readonly>
                </div>

                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px;">
                <label for="cgst" class="">CGST</label>
                <!-- <div class="col-sm-2"> -->
                    </div>
                    <input type="number" class="form-control" name="cgst" id="cgst" value="0.00" step="0.1" readonly>
                </div>

                <div class="d-flex align-items-center">
                    <div class="col-md-8 col-8" style="width: 100px;">
                <label for="sgst" class="">SGST</label>
                <!-- <div class="col-sm-2"> -->
                    </div>
                    <input type="number" class="form-control" name="sgst" id="sgst" value="0.00" step="0.1" readonly>
                </div>

                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px;">
                <label for="igst" class="">IGST</label>
                    </div>
                    <input type="number" class="form-control" name="igst" id="igst" value="0.00" step="0.1" readonly>
                </div>

                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px;">
                <label for="grand_total" class="">Grand Total</label>
                    </div>
                    <input type="number" class="form-control" name="grand_total" id="grand_total" readonly>
                </div>
            </div>

            </div>
        </div>
         <!-- Buttons -->
         <div class="">
            <div class="col-sm-12 text-end">
                <a href="{% url 'main:index' %}" id="" class="btn btn-danger btn-sm">Cancel</a>
                <button type="submit" id="print-button" class="btn btn-secondary btn-sm print-button" name="action" value="print">Print</button>
                <button type="button" onclick="clearForm()" class="btn btn-info btn-sm" style="margin-top: -45px;">Clear</button>
                <button type="submit" id="" class="btn btn-success btn-sm" name="action" value="save">Save</button>
            </div>
    </div>
</form>


</div>
</div>

 <!-- </div>
</div> -->















<!-- --------------------------  INVOICE ----------------------------------- -->



<div id="invoice-section" style="display: none;">
    <div style="padding: 20px; font-family: Arial;">
        <!-- Company Header -->
        <div style="text-align: center; margin-bottom: 20px;">
            <h1 style="margin: 0; font-size: 28px;">{{ master.company.companyname }}</h1>
            <p style="margin: 5px 0;">
                {{ master.company.address1 }},
                {% if master.company.address2 %}{{ master.company.address2 }}, {% endif %}
                {% if master.company.address3 %}{{ master.company.address3 }}, {% endif %}
                PIN - {{ master.company.pinCode }}
            </p>
            <p style="margin: 0;">
                {% if master.company.phoneno %}Phone: {{ master.company.phoneno }}{% endif %}
                {% if master.company.mobile %}Phone: {{ master.company.mobile }}{% endif %}
                {% if master.company.phoneno and master.company.email %} | {% endif %}
                {% if master.company.email %}Email: {{ master.company.email }}{% endif %}
            </p>
        </div>

        <hr style="border: 0.5px solid #585858; margin: 3px 0;">
        <h2 style="text-align: center; margin: 5px 0;">INVOICE</h2>
        <hr style="border: 0.5px solid #585858; margin: 3px 0;">

        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 14px;">
            <!-- Left Column -->
            <div style="flex: 1;">
                <p><strong>Bill No:</strong> <span>{{ master.bill_no }}</span></p>
                <p><strong>Bill Date:</strong> <span>{{ master.bill_date }} </span></p>
            </div>
        
            <!-- Middle Column -->
            <div style="flex: 1; text-align: center;">
                <p style="font-weight: bold; font-size: 16px;">ORIGINAL / DUPLICATE / TRIPLICATE</p>
            </div>
        
            <!-- Right Column -->
            <div style="flex: 1; text-align: right;">
                <p><strong>GSTIN:</strong> {{ master.company.gst }}</p>
                <p><strong>PAN:</strong> {{ master.company.pan }}</p>
            </div>
        </div>

        <hr style="border: 0.5px solid #585858; margin: 3px 0;">

        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 14px;">
            <!-- Left Column -->
            <div style="flex: 1;">
                <p><strong>Billed To:</strong> <span> {{ master.customer.head }} </span></p>
            </div>
        </div>

        <hr style="border: 0.5px solid #585858; margin: 3px 0;">

        <div style="margin-top: 10px; margin-bottom: 20px; font-size: 14px;">
            {% if account_master %}
            {{ account_master.address1 }}<br>
            {% if account_master.address2 %}{{ account_master.address2 }}<br>{% endif %}
            {% if account_master.address3 %}{{ account_master.address3 }}<br>{% endif %}
            <div>
                <strong>GST No:</strong> {{ account_master.gstno }} &nbsp;&nbsp;
                <strong>Phone:</strong> {{ account_master.mobile|default:account_master.telno }}
            </div>
            {% endif %}
        </div>

        <hr style="border: 0.5px solid #585858; margin: 3px 0;">

        <div style="display: flex; flex-direction: column; min-height: 100vh;">
            <!-- Content Section (Main Content) -->
            <div style="flex-grow: 1;">
                <!-- Table Section -->
                <div style="width: 100%;">
                    <table style="border: 1px solid black; border-collapse: collapse; width: 100%; font-size: 10px;">
                        <thead>
                            <tr style="background-color: #f2f2f2;">
                                <th style="padding: 2px;">Sl.no</th>
                                <th style="padding: 2px;">Code</th>
                                <th style="padding: 2px;">Vehicle No:</th>
                                <th style="padding: 2px;">Vehicle Type</th>
                                <th style="padding: 2px;">Total KM</th>
                                <th style="padding: 2px;">KM Rate</th>
                                <th style="padding: 2px;">E.Hr.Rate</th>
                                <th style="padding: 2px;">Fixed</th>
                                <th style="padding: 2px;">Toll Parking</th>
                                <th style="padding: 2px;">Haulting</th>
                                <th style="padding: 2px;">M. Fixed</th>
                                <th style="padding: 2px;">Gross Amount</th>
                                <th style="padding: 2px;">Tax %</th>
                                <th style="padding: 2px; color: black;">Net Value</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-trip-body" style="height: 30px;">
                            {% for child in children %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ child.code }}</td>
                                <td>{{ child.vehicle_no }}</td>
                                <td>{{ child.vehicle_type }}</td>
                                <td>{{ child.total_km }}</td>
                                <td>{{ child.km_rate }}</td>
                                <td>{{ child.ehr_rate }}</td>
                                <td>{{ child.fixed_charge }}</td>
                                <td>{{ child.toll_parking }}</td>
                                <td>{{ child.haulting }}</td>
                                <td>0.00</td>
                                <td>{{ child.tax }}</td>
                                <td>{{ child.gross_amount }}</td>
                                <td style="background-color: gray; color: black;">{{ child.net_value }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
        



        <!-- Bank Details and Summary Section -->
        <div style="display: flex; justify-content: space-between; margin-top: 20px; margin-bottom: 30px;">
            <!-- Left - Bank Details -->
            <div style="width: 60%; padding-right: 30px; border-right: 1px solid #ccc;">
                <div style="text-align: center; font-weight: bold; margin-bottom: 17px;">Bank Details</div>

                <div style="display: flex;">
                    <div style="width: 40%;">
                        <div style="height: 40px;">Bank Name:</div>
                        <div style="height: 40px;">Branch:</div>
                        <div style="height: 40px;">Account Number:</div>
                        <div style="height: 40px;">IFSC Code:</div>
                    </div>
                    <div style="width: 60%;">
                        <div style="height: 40px;"><span id="print_bank_name">Federal Bank</span></div>
                        <div style="height: 40px;"><span id="print_branch">Palayam</span></div>
                        <div style="height: 40px;"><span id="print_account_no">852963741012365</span></div>
                        <div style="height: 40px;"><span id="print_ifsc">FDRL12345</span></div>
                    </div>
                </div>
            </div>

            <!-- Right - Calculation Summary -->
            <div style="width: 38%; padding-left: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>Gross Amount</div><div><span> {{ master.total_gross }} </span></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>CGST</div><div><span> {{ master.cgst }} </span></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>SGST</div><div><span> {{ master.sgst }} </span></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>IGST</div><div><span> {{ master.igst }} </span></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>SP. Disc (%)</div><div><span>{{ master.sp_disc_perc }}</span></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>SP. Disc Amt</div><div><span>{{ master.sp_disc_amt }}</span></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>Total Discounts</div><div><span>{{ master.total_discounts }}</span></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>Round Off</div><div><span>{{ master.round_off }}</span></div>
                </div>
                <div style="border-top: 1px solid #000; margin-top: 10px; padding-top: 8px; display: flex; justify-content: space-between; font-weight: bold;">
                    <div>Grand Total</div><div><span>{{ master.grand_total }}</span></div>
                </div>
            </div>
        </div>

        <hr style="border: 0.5px solid #585858; margin: 3px 0;">

        <!-- Bottom Signature Section -->
        <div style="display: flex; justify-content: space-between; margin-top: 30px;">
            <input type="hidden" id="grand_total_field" value="{{ master.grand_total }}">
            <div style="width: 60%;">
                <p>Total Amount in Words:</p>
                <span id="amount-in-words"></span>
                <p style="font-size: 12px; color: red;">
                    NB: All complaints should be reported within a week. Bill payments must be made immediately; otherwise, interest will be charged at 15% per annum.
                </p>
            </div>
            <div style="width: 35%; text-align: right;">
                <strong>For {{ master.company.companyname }}</strong>
                <div style="margin-top: 60px;">
                    Authorised Signatory
                </div>
            </div>
        </div>
    </div>
</div>
            <!-- End of Content Section -->
        </div>


<!-- --------------------------  INVOICE END ----------------------------------- -->


















<script src="{% static 'vendor/jquery-3.2.1.min.js' %}"></script>
<script>
function addRow() {
    let table = document.getElementById("tripTable").getElementsByTagName('tbody')[0];
    let newRow = table.rows[0].cloneNode(true);

    // Update Sl.no as plain text
    let rowCount = table.rows.length;
    newRow.cells[0].innerText = rowCount + 1; // cells[0] = first <td>

    // Clear all input fields
    let inputs = newRow.getElementsByTagName("input");
    for (let i = 0; i < inputs.length; i++) {
        inputs[i].value = "";
    }

    table.appendChild(newRow);
}

    function removeRow(button) {
        let table = document.getElementById("tripTable").getElementsByTagName('tbody')[0];
        let row = button.closest("tr");

        if (table.rows.length > 1) {
            row.remove();
            resetSlNumbers();  // Reset sl_no after removing a row
        } else {
            alert("At least one row must remain.");
        }
    }

    function resetSlNumbers() {
    let table = document.getElementById("tripTable").getElementsByTagName('tbody')[0];
    let rows = table.getElementsByTagName("tr");

    for (let i = 0; i < rows.length; i++) {
        rows[i].cells[0].innerText = i + 1; // update the Sl.no column
    }
}
function deleteRow(btn) {
    const row = btn.closest('tr');
    const tbody = row.parentNode;
    const rows = tbody.querySelectorAll('tr');

    if (rows.length <= 1) {
        alert("At least one row must remain.");
        return;
    }

    row.remove();
    resetSlNumbers(); // Call this to re-number rows
}
</script>

<!-- Bootstrap JS-->
<script src="{% static 'vendor/bootstrap-4.1/popper.min.js' %}"></script>
<script src="{% static 'vendor/bootstrap-4.1/bootstrap.min.js' %}"></script>
<!-- Vendor JS       -->
<script src="{% static 'vendor/slick/slick.min.js' %}">
</script>
<script src="{% static 'vendor/wow/wow.min.js' %}"></script>
<script src="{% static 'vendor/animsition/animsition.min.js' %}"></script>
<script src="{% static 'vendor/bootstrap-progressbar/bootstrap-progressbar.min.js' %}">
</script>
<script src="{% static 'vendor/counter-up/jquery.waypoints.min.js' %}"></script>
<script src="{% static 'vendor/counter-up/jquery.counterup.min.js' %}">
</script>
<script src="{% static 'vendor/circle-progress/circle-progress.min.js' %}"></script>
<script src="{% static 'vendor/perfect-scrollbar/perfect-scrollbar.js' %}"></script>
<script src="{% static 'vendor/chartjs/Chart.bundle.min.js' %}"></script>
<script src="{% static 'vendor/select2/select2.min.js' %}">
</script>

<!-- Main JS-->
<script src="{% static 'js/main.js' %}"></script>
<script>
    document.getElementById('series').addEventListener('change', function () {
        const seriesId = this.value;
        if (seriesId) {
            fetch(`/demo.com/get-serial-number/?series_id=${seriesId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.serial_no !== undefined) {
                        $('input[name="entry_number"]').val(data.serial_no);
                    } else {
                        document.getElementById('entry_number').value = '';
                    }
                })
                .catch(error => {
                    console.error('Error fetching serial number:', error);
                    document.getElementById('entry_number').value = '';
                });
        } else {
            document.getElementById('entry_number').value = '';
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
    const customerInput = document.getElementById("customer_name");
    const customerIdInput = document.getElementById("customer_id");
    const customerList = document.getElementById("customerList");

    customerInput.addEventListener("input", function () {
    let query = this.value;
    if (!query) {
        customerList.innerHTML = "";
        return;
    }

    fetch(`/demo.com/ajax/autocomplete-customers/?term=${query}`)
        .then(res => res.json())
        .then(data => {
            customerList.innerHTML = "";
            data.forEach(item => {
                const div = document.createElement("div");
                div.textContent = item.label;
                div.classList.add("list-group-item", "list-group-item-action");
                div.onclick = function () {
                    customerInput.value = item.label;
                    customerIdInput.value = item.account_code;

                    // Set Address and GSTIN dynamically
                    document.getElementById("address").value = item.address;
                    document.getElementById("gst").value = item.gstno;

                    customerList.innerHTML = "";
                };
                customerList.appendChild(div);
            });
        });
});

    document.addEventListener("click", function (e) {
        if (!customerList.contains(e.target) && e.target !== customerInput) {
            customerList.innerHTML = "";
        }
    });
});
</script>
<script>
    function fetchTripData() {
    const series = document.getElementById("series").value;
    const from_date = document.getElementById("from_date").value;
    const to_date = document.getElementById("to_date").value;
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("/demo.com/get-trip-data/", {
        method: "POST",
        headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrfToken
        },
        body: JSON.stringify({
            series: series,
            from_date: from_date,
            to_date: to_date
        })
    })
    .then(response => response.json())
    .then(data => {
        populateTripTable(data.trips);
        populateTotals(data.totals);
    })
    .catch(error => console.error("Error:", error));
}

function populateTripTable(trips) {
    const tbody = document.querySelector("#tripTable tbody");
    tbody.innerHTML = "";

    trips.forEach((trip, index) => {
        const row = document.createElement("tr");
        row.innerHTML = `
            <td>${index + 1}</td>
            <td><input type="text" name="code[]" value="${trip.code || ''}" /></td>
            <td><input type="text" name="vehicle_no[]" value="${trip.vehicle_number}" /></td>
            <td><input type="text" name="vehicle_type[]" value="${trip.vehicle_type}" /></td>
            <td><input type="number" name="km_rate[]" value="${trip.km_rate || 0}" step="0.01" /></td>
            <td><input type="number" name="ehr_rate[]" value="${trip.extra_hour_charge_total || 0}" step="0.01" /></td>
            <td><input type="number" name="fixed[]" value="${trip.fixed_charge_total || 0}" step="0.01" /></td>
            <td><input type="number" name="toll_parking[]" value="${trip.toll_parking_total || 0}" step="0.01" /></td>
            <td><input type="number" name="haulting[]" value="${trip.haulting_charge_total || 0}" step="0.01" /></td>
            <td><input type="number" name="gross_amount[]" value="${trip.total_freight_charges || 0}" step="0.01" /></td>
            <td><input type="number" name="monthly_fixed[]" value="0" step="0.01" /></td>
            <td><input type="number" name="tax[]" value="0" step="0.01" /></td>
            <td><button type="button" class="btn-delete" onclick="deleteRow(this)">&#10006;</button></td>
        `;
        tbody.appendChild(row);
    });
}

function populateTotals(totals) {
    document.getElementById("total_gross").value = totals.total_gross || 0;
    document.getElementById("net_total").value = totals.net_total || 0;
    document.getElementById("cgst").value = totals.cgst || 0;
    document.getElementById("sgst").value = totals.sgst || 0;
    document.getElementById("igst").value = totals.igst || 0;
    document.getElementById("grand_total").value = totals.grand_total || 0;
}
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
    // 1. Calculate net value for each row
    function updateRowNetValues() {
        const rows = document.querySelectorAll("#tripTable tbody tr");
        rows.forEach(function(row) {
            const tds = row.querySelectorAll("td");
            if (tds.length < 13) return;

            const grossAmountCell = tds[11];
            const monthlyFixedCell = tds[10];
            const taxCell = tds[12];
            const netValueElement = row.querySelector(".net_value");

            if (!grossAmountCell || !taxCell || !netValueElement) return;

            const grossAmount = parseFloat(grossAmountCell.innerText.replace(/,/g, '').trim()) || 0;
            const monthlyFixed = parseFloat(monthlyFixedCell.innerText.replace(/,/g, '').trim()) || 0;
            const taxPercent = parseFloat(taxCell.innerText.replace(/,/g, '').trim()) || 0;

            const taxAmount = (grossAmount * taxPercent) / 100;
            const updatedNet = grossAmount + taxAmount + monthlyFixed;

            netValueElement.innerText = updatedNet.toFixed(2);
        });
    }

    // 2. Calculate total gross and set net_total
    function calculateTotals() {
        const rows = document.querySelectorAll("#tripTable tbody tr");
        let totalGross = 0;

        rows.forEach(function(row) {
            const tds = row.querySelectorAll("td");
            if (tds.length < 13) return;

            const grossText = tds[11].innerText.replace(/,/g, '').trim();
            const gross = parseFloat(grossText) || 0;
            totalGross += gross;
        });

        document.getElementById("total_gross").value = totalGross.toFixed(2);
        document.getElementById("net_total").value = totalGross.toFixed(2);
    }

    // 3. Calculate CGST and SGST
    function updateGSTAmounts() {
    const gstType = document.getElementById("gst_type").value;  // Get the selected GST type (GST or IGST)
    const rows = document.querySelectorAll("#tripTable tbody tr");
    let totalTax = 0;

    rows.forEach(function(row) {
        const taxPercentCell = row.querySelectorAll("td")[12]; // Tax percent column (GST rate)
        const freightChargeCell = row.querySelectorAll("td")[11]; // Gross amount column

        const taxPercent = parseFloat(taxPercentCell?.innerText) || 0; // Get the tax rate (GST rate)
        const freightCharge = parseFloat(freightChargeCell?.innerText) || 0; // Get the freight charge (gross amount)

        // Calculate tax amount based on the rate
        const taxAmount = (freightCharge * (taxPercent / 100)); // Ensure tax percent is divided by 100
        totalTax += taxAmount;
    });

    // Check if IGST is selected
    if (gstType === 'igst') {
        document.getElementById("igst").value = totalTax.toFixed(2); // Set IGST as the total tax amount
        document.getElementById("cgst").value = '0.00';  // Set CGST to 0
        document.getElementById("sgst").value = '0.00';  // Set SGST to 0
    } else {
        // Split tax equally between CGST and SGST
        const halfTax = (totalTax / 2).toFixed(2);
        document.getElementById("cgst").value = halfTax;  // Half the tax for CGST
        document.getElementById("sgst").value = halfTax;  // Half the tax for SGST
        document.getElementById("igst").value = '0.00';  // Set IGST to 0
    }
}

            // 4. Update Grand Total
        function updateGrandTotal() {
    const spDiscPercent = parseFloat(document.getElementById('sp_disc_percent').value) || 0;
    const spDiscAmt = parseFloat(document.getElementById('sp_disc_amt').value) || 0;

    const netTotal = parseFloat(document.getElementById('net_total').value) || 0;
    const cgst = parseFloat(document.getElementById('cgst').value) || 0;
    const sgst = parseFloat(document.getElementById('sgst').value) || 0;
    const igst = parseFloat(document.getElementById('igst').value) || 0;

    // Grand total before discount
    let grandTotalBeforeDiscount = netTotal + cgst + sgst + igst;

    // Apply % discount first
    let percentDiscountAmt = (grandTotalBeforeDiscount * spDiscPercent) / 100;

    // Apply amount discount as well
    let discountedGrandTotal = grandTotalBeforeDiscount - percentDiscountAmt - spDiscAmt;

    // Round to nearest integer
    let roundedTotal = Math.round(discountedGrandTotal);

    // Calculate round off
    let roundOffValue = roundedTotal - discountedGrandTotal;

    // Update DOM
    document.getElementById('round_off').value = roundOffValue.toFixed(2);
    document.getElementById('grand_total').value = roundedTotal.toFixed(2);
}



    // 5. Update GST amounts based on GST type selection
    function updateGSTType() {
        const gstType = document.getElementById("gst_type").value;  // Get selected GST type
        const totalTaxAmount = parseFloat(document.getElementById("net_total").value) || 0;  // Total tax is based on net total

        if (gstType === "igst") {
            // Set IGST to total tax amount, and CGST/SGST to 0
            document.getElementById("igst").value = totalTaxAmount.toFixed(2);
            document.getElementById("cgst").value = "0.00";
            document.getElementById("sgst").value = "0.00";
        } else if (gstType === "gst") {
            // Split total tax amount equally for CGST and SGST
            const halfTaxAmount = (totalTaxAmount / 2).toFixed(2);
            document.getElementById("cgst").value = halfTaxAmount;
            document.getElementById("sgst").value = halfTaxAmount;
            document.getElementById("igst").value = "0.00";
        }
    }

    function updateTotalKm() {
        const rows = document.querySelectorAll("#tripTable tbody tr");
        let totalKm = 0;

        rows.forEach(function(row) {
            const kmCell = row.querySelectorAll("td")[4]; // Total KM column
            const kmValue = parseFloat(kmCell?.innerText) || 0;
            totalKm += kmValue;
        });

        document.getElementById("total_km").value = totalKm.toFixed(2);
    }

    // 6. Event listener for GST type change
    document.getElementById("gst_type").addEventListener("change", updateGSTType);

    // 7. Full Flow
    updateTotalKm();
    updateRowNetValues();
    calculateTotals();
    updateGSTAmounts();
    updateGrandTotal();

    // 8. Attach event listeners (discount, roundoff changes)
    const spDiscPercent = document.getElementById('sp_disc_percent');
    const spDiscAmt = document.getElementById('sp_disc_amt');
    const roundOff = document.getElementById('round_off');

    [spDiscPercent, spDiscAmt, roundOff].forEach(el => {
        if (el) el.addEventListener('input', function() {
            updateGrandTotal();
        });
    });
});

document.addEventListener('DOMContentLoaded', function () {
    const gstTypeSelect = document.getElementById("gst_type");
    
    gstTypeSelect.addEventListener('change', function () {
        const gstType = this.value;  // Get the selected GST type (GST or IGST)
        updateGSTAmounts(gstType);  // Call the function to update GST amounts
    });

    function updateGSTAmounts(gstType) {
        const rows = document.querySelectorAll("#tripTable tbody tr");
        let totalTax = 0;

        // Loop through each row to calculate the total tax
        rows.forEach(function (row) {
            const taxPercentCell = row.querySelectorAll("td")[12];  // Tax percent column (GST rate)
            const freightChargeCell = row.querySelectorAll("td")[11];  // Gross amount column

            const taxPercent = parseFloat(taxPercentCell?.innerText) || 0; // Get the tax rate (GST rate)
            const freightCharge = parseFloat(freightChargeCell?.innerText) || 0; // Get the freight charge (gross amount)

            // Calculate the tax amount using the tax percentage correctly (divide by 100 to get percentage)
            const taxAmount = (freightCharge * taxPercent) / 100;  // Corrected formula
            totalTax += taxAmount;
        });

        // Check if IGST is selected
        if (gstType === 'igst') {
            document.getElementById("igst").value = totalTax.toFixed(2); // Set IGST as the total tax amount
            document.getElementById("cgst").value = '0.00';  // Set CGST to 0
            document.getElementById("sgst").value = '0.00';  // Set SGST to 0
        } else {
            // Split tax equally between CGST and SGST
            const halfTax = (totalTax / 2).toFixed(2);
            document.getElementById("cgst").value = halfTax;  // Half the tax for CGST
            document.getElementById("sgst").value = halfTax;  // Half the tax for SGST
            document.getElementById("igst").value = '0.00';  // Set IGST to 0
        }
    }
});
    </script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
    const spDiscPercent = document.getElementById('sp_disc_percent');
    const spDiscAmt = document.getElementById('sp_disc_amt');
    const roundOff = document.getElementById('round_off');
    const grandTotal = document.getElementById('grand_total');

    // Store the original (undiscounted) grand total on load
    if (grandTotal) {
        grandTotal.setAttribute('data-original', grandTotal.value);
    }
    });
</script>
{% if print %}
<script>
    function numberToWords(num) {
    const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine',
               'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen',
               'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
    const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

    function inWords(n) {
        if ((n = n.toString()).length > 9) return 'Overflow';
        const nStr = ('000000000' + n).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
        if (!nStr) return;
        let str = '';
        str += (Number(nStr[1]) !== 0) ? (a[Number(nStr[1])] || b[nStr[1][0]] + ' ' + a[nStr[1][1]]) + ' Crore ' : '';
        str += (Number(nStr[2]) !== 0) ? (a[Number(nStr[2])] || b[nStr[2][0]] + ' ' + a[nStr[2][1]]) + ' Lakh ' : '';
        str += (Number(nStr[3]) !== 0) ? (a[Number(nStr[3])] || b[nStr[3][0]] + ' ' + a[nStr[3][1]]) + ' Thousand ' : '';
        str += (Number(nStr[4]) !== 0) ? (a[Number(nStr[4])] || b[nStr[4][0]] + ' ' + a[nStr[4][1]]) + ' Hundred ' : '';
        str += (Number(nStr[5]) !== 0) ? ((str !== '') ? 'and ' : '') +
            (a[Number(nStr[5])] || b[nStr[5][0]] + ' ' + a[nStr[5][1]]) + ' ' : '';
        return str.trim();
    }

    return inWords(num);
}
Swal.fire({
    icon: 'success',
    title: 'Bill Created Successfully',
    text: 'Your bill has been saved.',
    confirmButtonText: 'Print',
    showCancelButton: true,
    cancelButtonText: 'Close'
}).then((result) => {
    if (result.isConfirmed) {
       let grandTotal = document.getElementById("grand_total_field").value || "0";
        let words = numberToWords(parseInt(grandTotal));
        document.getElementById("amount-in-words").innerText = words + " Only";

        // ? Now copy the updated invoice content
        const printContents = document.getElementById("invoice-section").innerHTML;
        const printWindow = window.open('', '', 'height=800,width=1000');

        printWindow.document.write(`
            <html>
            <head>
                <title>Invoice</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    hr { border: 0.5px solid #ccc; margin: 10px 0; }
                </style>
            </head>
            <body>
                ${printContents}
            </body>
            </html>
        `);
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    }
});
</script>
{% elif status == 'success' %}
<script>
    Swal.fire({
        icon: 'success',
        title: 'Success',
        text: 'Bill Saved Successfully',
        confirmButtonText: 'OK',
    });
</script>
{% elif status == 'error' %}
<script>
    Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Error Saving the Bill....Please Try Again.....!!!',
        confirmButtonText: 'OK'
    });
</script>
{% endif %}

<script>
    document.getElementById("bill-form").addEventListener("submit", function (e) {
        const rows = document.querySelectorAll("tr");
        rows.forEach(function (row) {
            const td = row.querySelector(".net_value.freight-value");
            const input = row.querySelector(".net_value_input");

            if (td && input) {
                input.value = td.textContent.trim();
            }
        });
    });
</script>
<script>
   document.addEventListener("DOMContentLoaded", function() {
    // Add event listeners to recalculate values when any of the input fields are changed
    document.querySelectorAll('.table_data').forEach(input => {
        input.addEventListener('input', function() {
            const row = input.closest('tr');
            const tripId = row.querySelector('input[name^="km_rate_"]').name.split('_')[2]; // Extract trip ID
            recalculateRow(row, tripId); // Recalculate values for this row
        });
    });
});

function recalculateRow(row) {
    const kmRate = parseFloat(row.querySelector('input[name^="km_rate_"]').value) || 0;
    const extraHr = parseFloat(row.querySelector('input[name^="extra_hour_rate_"]').value) || 0;
    const toll = parseFloat(row.querySelector('input[name^="toll_parking_"]').value) || 0;
    const haulting = parseFloat(row.querySelector('input[name^="haulting_"]').value) || 0;

    const fixedChargeCell = row.querySelector('.fixed-charge');
    const fixedCharge = parseFloat(fixedChargeCell?.textContent.trim()) || 0;

    const taxCell = row.querySelector("td:nth-child(13)");
    const taxPercent = parseFloat(taxCell.textContent.trim()) || 0;

    // Now include fixed charge in gross amount
    const grossAmount = kmRate + extraHr + toll + haulting + fixedCharge;

    const taxAmount = grossAmount * taxPercent / 100;
    const netAmount = grossAmount + taxAmount;

    // Update the Gross Amount in the table
    row.querySelector("td:nth-child(12)").textContent = grossAmount.toFixed(2);

    // Update the Net Value in the table
    row.querySelector("td.net_value").textContent = netAmount.toFixed(2);
    row.querySelector("input.net_value_input").value = netAmount.toFixed(2);
    row.querySelector("input.freight_charges_input").value = grossAmount.toFixed(2);

    updateTotalValues();
}


function updateTotalValues() {
    let totalGross = 0;
    let totalNet = 0;
    let totalCGST = 0;
    let totalSGST = 0;
    let totalIGST = 0;

    const rows = document.querySelectorAll("#tripTable tbody tr");
    rows.forEach((row) => {
        const grossAmount = parseFloat(row.querySelector("td:nth-child(12)").textContent) || 0;
        const freightCharge = parseFloat(row.querySelector("input.freight_charges_input").value) || 0;
        const taxPercent = parseFloat(row.querySelector("td:nth-child(13)").textContent) || 0;

        totalGross += grossAmount;
        totalNet += freightCharge;

        const cgstAmount = parseFloat(((freightCharge * taxPercent / 100) / 2).toFixed(2));
        const sgstAmount = cgstAmount;
        const igstAmount = 0;

        totalCGST += cgstAmount;
        totalSGST += sgstAmount;
        totalIGST += igstAmount;
    });

    // Round intermediate totals to 2 decimals
    totalGross = parseFloat(totalGross.toFixed(2));
    totalNet = parseFloat(totalNet.toFixed(2));
    totalCGST = parseFloat(totalCGST.toFixed(2));
    totalSGST = parseFloat(totalSGST.toFixed(2));
    totalIGST = parseFloat(totalIGST.toFixed(2));

    // Update totals in DOM
    document.getElementById("total_gross").value = totalGross.toFixed(2);
    document.getElementById("net_total").value = totalNet.toFixed(2);
    document.getElementById("cgst").value = totalCGST.toFixed(2);
    document.getElementById("sgst").value = totalSGST.toFixed(2);
    document.getElementById("igst").value = totalIGST.toFixed(2);

    // --- Discount Section ---
    const spDiscPercent = parseFloat(document.getElementById('sp_disc_percent').value) || 0;
    const spDiscAmt = parseFloat(document.getElementById('sp_disc_amt').value) || 0;

    // Calculate grand total before rounding
    let grandTotalBeforeDiscount = totalNet + totalCGST + totalSGST + totalIGST;

    // Apply percentage discount
    let discountFromPercent = (grandTotalBeforeDiscount * spDiscPercent) / 100;

    // Apply fixed amount discount
    let grandTotalAfterDiscount = grandTotalBeforeDiscount - discountFromPercent - spDiscAmt;

    // Round grand total
    let grandTotalRounded = Math.round(grandTotalAfterDiscount);

    // Calculate round-off
    let roundOff = grandTotalRounded - grandTotalAfterDiscount;

    // Update grand total and round-off in DOM
    document.getElementById("grand_total").value = grandTotalRounded.toFixed(2);
    document.getElementById("round_off").value = roundOff.toFixed(2);
}

// Optional: live update when table or discount inputs change
document.querySelectorAll("#tripTable input.freight_charges_input").forEach(input => {
    input.addEventListener("input", updateTotalValues);
});
document.getElementById('sp_disc_percent').addEventListener("input", updateTotalValues);
document.getElementById('sp_disc_amt').addEventListener("input", updateTotalValues);
</script>



<script>
function clearForm() {
    window.location.href = "{% url 'main:bill_details' %}";
}
</script>


<script>
    document.getElementById("rate_type").addEventListener("change", function () {
        const rateType = this.value;
        console.log("Selected Rate Type:", rateType); 
        
    });
</script>


<!-- --------------------------   SCRIPT FOR INVOICE     ---------------------- -->



<script>
    document.getElementById("print-button").addEventListener("click", function () {
        const billNo = document.getElementById("entry_number").value;
        const billDateRaw = document.getElementById("bill_date").value;
        const billDateParts = billDateRaw.split("-");
        const billDateFormatted = `${billDateParts[2]}-${billDateParts[1]}-${billDateParts[0]}`;
        const billedTo = document.getElementById("customer_name").value;
    
        document.getElementById("print-bill-no").textContent = billNo;
        document.getElementById("print-bill-date").textContent = billDateFormatted;
        document.getElementById("print-billed-to").textContent = billedTo;
        document.getElementById("print_total_gross").textContent = document.getElementById("total_gross").value;
        document.getElementById("print_cgst").textContent = document.getElementById("cgst").value;
        document.getElementById("print_sgst").textContent = document.getElementById("sgst").value;
        document.getElementById("print_igst").textContent = document.getElementById("igst").value;
        document.getElementById("print_sp_disc_percent").textContent = document.getElementById("sp_disc_percent").value;
        document.getElementById("print_sp_disc_amt").textContent = document.getElementById("sp_disc_amt").value;
        document.getElementById("print_total_discount").textContent = document.getElementById("total_discounts").value;
        document.getElementById("print_round_off").textContent = document.getElementById("round_off").value;
        document.getElementById("print_grand_total").textContent = document.getElementById("grand_total").value;
    
        // ? Convert and insert amount in words
        const grandTotal = parseFloat(document.getElementById("grand_total").value || 0);
        const amountWords = convertNumberToWords(grandTotal);
        document.getElementById("amount-in-words").textContent = amountWords;
    
        // Update invoice table
        const invoiceBody = document.getElementById("invoice-trip-body");
        invoiceBody.innerHTML = "";
    
        const tripRows = document.querySelectorAll("#tripTable tbody tr");
        tripRows.forEach((row, index) => {
            const entryNo = row.children[1]?.innerText.trim();
            const vehicleNo = row.children[2]?.innerText.trim();
            const vehicleType = row.children[3]?.innerText.trim();
    
            const kmRate = row.querySelector(`[name^='km_rate_']`)?.value || '0.00';
            const extraHrRate = row.querySelector(`[name^='extra_hour_rate_']`)?.value || '0.00';
            const fixedCharge = row.querySelector(".fixed-charge")?.textContent.trim() || '0.00';
            const tollParking = row.querySelector(`[name^='toll_parking_']`)?.value || '0.00';
            const haulting = row.querySelector(`[name^='haulting_']`)?.value || '0.00';
            const tax = row.children[10]?.innerText.trim();
            const grossAmount = row.children[11]?.innerText.trim(); 
            const netValue = row.querySelector(".net_value")?.innerText.trim() || '0.00';
    
            const printRow = `
                <tr>
                    <td>${index + 1}</td>
                    <td>${entryNo}</td>
                    <td>${vehicleNo}</td>
                    <td>${vehicleType}</td>
                    <td>${kmRate}</td>
                    <td>${extraHrRate}</td>
                    <td>${fixedCharge}</td>
                    <td>${tollParking}</td>
                    <td>${haulting}</td>
                    <td>0.00</td>
                    <td>${tax}</td>
                    <td>${grossAmount}</td>
                    <td style="background-color: gray; color: black;">${netValue}</td>
                </tr>
            `;
            invoiceBody.innerHTML += printRow;
        });
    
        // Print
        const printContents = document.getElementById("invoice-section").innerHTML;
        const printWindow = window.open('', '', 'height=800,width=1000');
    
        printWindow.document.write(`
            <html>
            <head>
                <title>Invoice</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    hr { border: 0.5px solid #ccc; margin: 10px 0; }
                </style>
            </head>
            <body>
                ${printContents}
            </body>
            </html>
        `);
    
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    });
    
    function numberToWords(num) {
    const a = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine',
               'Ten', 'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen',
               'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
    const b = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

    function inWords (n) {
        if ((n = n.toString()).length > 9) return 'Overflow';
        const nStr = ('000000000' + n).substr(-9).match(/^(\d{2})(\d{2})(\d{2})(\d{1})(\d{2})$/);
        if (!nStr) return;
        let str = '';
        str += (Number(nStr[1]) !== 0) ? (a[Number(nStr[1])] || b[nStr[1][0]] + ' ' + a[nStr[1][1]]) + ' Crore ' : '';
        str += (Number(nStr[2]) !== 0) ? (a[Number(nStr[2])] || b[nStr[2][0]] + ' ' + a[nStr[2][1]]) + ' Lakh ' : '';
        str += (Number(nStr[3]) !== 0) ? (a[Number(nStr[3])] || b[nStr[3][0]] + ' ' + a[nStr[3][1]]) + ' Thousand ' : '';
        str += (Number(nStr[4]) !== 0) ? (a[Number(nStr[4])] || b[nStr[4][0]] + ' ' + a[nStr[4][1]]) + ' Hundred ' : '';
        str += (Number(nStr[5]) !== 0) ? ((str !== '') ? 'and ' : '') + 
            (a[Number(nStr[5])] || b[nStr[5][0]] + ' ' + a[nStr[5][1]]) + ' ' : '';
        return str.trim();
    }

    return inWords(num);
}
    </script>
    
    
<!-- --------------------------   SCRIPT FOR INVOICE END     ---------------------- -->

{% endblock %}
