{% extends "base.html" %}
{% load static %}
{% block content %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bill Edit</title>
<!-- Fontfaces CSS-->
    <link href="{% static 'css/font-face.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/font-awesome-4.7/css/font-awesome.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/font-awesome-5/css/fontawesome-all.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/mdi-font/css/material-design-iconic-font.min.css' %}" rel="stylesheet" media="all">

    <!-- Bootstrap CSS-->
    <link href="{% static 'vendor/bootstrap-4.1/bootstrap.min.css' %}" rel="stylesheet" media="all">

    <!-- Vendor CSS-->
    <link href="{% static 'vendor/animsition/animsition.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/bootstrap-progressbar/bootstrap-progressbar-3.3.4.min.css' %}" rel="stylesheet"
          media="all">
    <link href="{% static 'vendor/wow/animate.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/css-hamburgers/hamburgers.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/slick/slick.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/select2/select2.min.css' %}" rel="stylesheet" media="all">
    <link href="{% static 'vendor/perfect-scrollbar/perfect-scrollbar.css' %}" rel="stylesheet" media="all">

    <!-- Main CSS-->
    <link href="{% static 'css/theme.css' %}" rel="stylesheet" media="all">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<style>
    @media print {
        body {
            width: 210mm;
            height: 297mm;
            margin: 0;
            padding: 0;
        }
        table {
            width: 100%;
        }
        #print-button {
            display: none;
        }
    }
        .form-control {
        padding: 2px 8px;
        font-size: 14px;
    }
    .mb-3, .mb-2 {
        margin-bottom: 8px !important;
        align-items: center;
    }
     body {
            font-family: Public Sans, sans-serif;
            background-color: #f4f4f4;

            margin: 0;
            padding: 0;
            font-size: 14px;
            align-items: center;
            color:black;

        }
         .logo p {
        color:white;
        }
        .container_box {
            background-color:antiquewhite;
            padding: 10px;
            border-radius: 8px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
            border: 2px solid rgb(43, 114, 227);
            margin-left:20px;
            margin-top:100px;
        }


        h2 {
            text-align: center;
            margin-bottom: 20px;
        }

        label {

            margin-bottom: 5px;
        }

        
        input, select {
            width: 100%;
           /* padding: 8px;*/
            /*border-radius: 5px;*/
            font-size: 10px;
        }
        select {
        background:white;
        

        }
        table {
            background:white;
            border-collapse: collapse;
            margin-top: 20px;
            margin-bottom:20px;
        }
        .table_input{
            border:none;
        }
        th {
            border: 1px solid black;
            background:#f2f2f2;
            padding:5px;
            text-align: center;
            font-size: 12px;
        }
        button {
            padding: 10px;
            background: #28a745;
            border: none;
            color: white;
            font-size: 16px;
            border-radius: 5px;
            cursor: pointer;
        }

        button:hover {
            background: #218838;
        }
        .btn {
            margin-top: -10px;
            display: inline-block;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 4px;
            color: white;
            margin-right:10px;
            margin-bottom:20px;
        }

        .btn-info{
            margin-top: -25px;
            display: inline-block;
            padding: 8px 15px;
            text-decoration: none;
            border-radius: 4px;
            color: white;
            margin-right:10px;
            margin-bottom:-15px; 
        }

        .save-btn { background-color: #28a745; }
        .back-btn { background-color: #007bff; }

        .input-right {
            text-align: right;
        }
    @media only screen and (max-width: 600px) {
  .container_box  {
    width: 90%;
  }
}
    label {
        font-weight: 500;
        width: 90px;
        font-size: 12px;
    }
    .form-group-row {
        display: flex;
        align-items: center;
        margin-bottom: 8px;
    }
    .form-group-row label {
        min-width: 120px;
        margin-right: 8px;
        margin-bottom: 0;
    }
    /* .table-container {
            margin-top: 20px;
            overflow-x: auto;
        } */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
        }
        th {
            border: 1px solid #999;
            padding: 2px;
            text-align: center;
        }
        td {
            border: 1px solid #999;
            padding: -4px;
            text-align: center;
            font-size: 11px;
        }
        th {
            background-color: #f2f2f2;
        }
        input[type="text"], input[type="number"] {
            /* width: 100%; */
            padding: -5px;
            box-sizing: border-box;
        }
        .btn-delete {
            color: white;
            border: none;
            padding: 0px 5px;
            cursor: pointer;
        }
        .btn-delete:hover {
            background-color: #c0392b;
        }
        .table_data {
            font-size: 12px;
            padding: 2px 4px;
            text-align: center;
            width: 70px; /* set a fixed width */
            max-width: 80px; /* prevent stretching */
            box-sizing: border-box;
        }
    .top-section {
        width: 210%;
        padding-left: 20px;
        padding-right: 340px;
    }



    .bottom-section {
    display: flex;
    justify-content: space-between;
    gap: 20px;
}

.column {
    padding: 2px;
    border-radius: 6px;
   /* box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);*/
}


.second-column {
    flex: 0.5; /* Center - less space */
    text-align: center;
}

.third-column {
    padding-left: 10px;
}

/* Optional: Ensure inputs are consistent */
.column input {
    width: 100%;
    font-size: 12px;
    margin-bottom: 8px;
}

/* Make labels a little smaller for alignment */
.column label {
    display: block;
    margin-bottom: 4px;
    font-size: 13px;
}
.d-flex.align-items-center {
    gap: 4px; /* Reduce space between label and input */
}

.d-flex.align-items-center > div {
    margin-bottom: 0;
    flex: 0 0 auto; /* Prevent stretching */
    padding-right: 4px; /* Small spacing */
}

.d-flex.align-items-center label {
    margin-bottom: 0;
    font-size: 12px; /* Optional: reduce font size */
    white-space: nowrap; /* Keep label on one line */
}

.d-flex.align-items-center input {
    flex: 1; /* Let input take remaining space */
    max-width: 150px; 
    font-size: 13px;
}


/* --------------------------- INVOICE STYLE ----------------------------- */

@media print {
    body * {
        visibility: hidden;
    }
    #print-invoice, #print-invoice * {
        visibility: visible;
    }
    #print-invoice {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
    }
}

/* --------------------------- INVOICE STYLE END ----------------------------- */
    </style>

 <div class="container_box">

 <div class="container">


<h2>Edit Bill</h2>

<form method="post" action="" id="bill-form">
    {% csrf_token %}
    <div class="container">
        <!-- ðŸ”¹ Top Section -->
        <div class="top-section">
               
            <div class="form-group row">
                <label for="series" class="">Series</label>
                <div class="col-sm-1">
                    <select name="series" id="series" class="form-control" required style="padding: 3px 6px; font-size: 13px; height: 30px;">
                        <option value="{{ bill_master.series.id }}">{{ bill_master.series.series }}</option>
                    </select>
                </div>

                <label for="entry_number" class="">Bill Number</label>
                <div class="col-sm-1">
                    <input type="text" name="entry_number" id="entry_number" class="form-control" value="{{ bill_master.bill_no }}" readonly required>
                </div>

                <label for="bill_date" class="">Bill Date</label>
                <div class="col-sm-1">
                    <input type="date" name="bill_date" id="bill_date" class="form-control" value="{{ bill_master.bill_date|date:'Y-m-d' }}" readonly required>
                </div>

                <label for="bill_date" style="margin-left: 17px;">GST Type</label>
                <div class="">
                    <select name="gst_type" id="gst_type" class="form-control" required style="width: 72px; font-size: 13px; height: 30px;">
                        {% if bill_master.gst_type == 'gst' %}
                        <option value="{{ bill_master.gst_type }}">GST</option>
                        {% else %}
                        <option value="{{ bill_master.gst_type }}">IGST</option>
                        {% endif %}
                    </select>
                </div>
            </div>

            <div class="form-group row">
                <label for="bill_type" class="">Bill Type</label>
                <div class="col-sm-1">
                    <select name="bill_type" id="bill_type" class="form-control" required style="padding: 3px 6px; font-size: 13px; height: 30px;">
                        <option value="Cash" {% if bill_master.bill_type == "Cash" %}selected{% endif %}>Cash</option>
                        <option value="Credit" {% if bill_master.bill_type == "Credit" %}selected{% endif %}>Credit</option>
                    </select>
                </div>

                <label for="customer_id" class="">Customer ID</label>
                <div class="col-sm-1">
                    <input type="text" name="customer_id" id="customer_id" class="form-control" value="{{ bill_master.customer.account_code }}" required readonly>
                </div>

                <label for="customer_name" class="">Customer Name</label>
                <div class="col-sm-1">
                    <input type="text" name="customer_name" id="customer_name" class="form-control" style="width: 310px;" value="{{ bill_master.customer.head }}" readonly required autocomplete="off">
                    <div id="customerList" class="autocomplete-items" style="position: absolute; z-index: 1000;"></div>
                </div>
            </div>

            <div class="form-group row">
                <label for="address" class="">Address</label>
                <div class="col-sm-1">
                    <input type="text" name="address" id="address" value="{{ bill_master.customer.address1 }}" class="form-control" readonly>
                </div>

                <label for="gst" class="">GSTIN</label>
                <div class="col-sm-1">
                    <input type="text" name="gst" id="gst" value="{{ bill_master.customer.gstno }}" class="form-control" readonly>
                </div>

                <label for="from_date">Date From</label>
                <div class="col-sm-1">
                    <input type="date" name="from_date" id="from_date" class="form-control" value="{{ bill_master.date_from | date:'Y-m-d' }}"  required readonly>
                </div>

                <label style="width: 42px; margin-left: 7px;" for="to_date" class="">Date To</label>
                <div class="col-sm-1">
                    <input type="date" name="to_date" id="to_date" class="form-control" value="{{ bill_master.date_to | date:'Y-m-d' }}"  required readonly>
                </div>
                <div class="col-sm-1 offset">
                    <!-- <button type="submit" class="btn btn-info" name="action" value="go" style="margin-right: 10px;">Go</button> -->
                </div>
            </div>
        </div>
        <!-- ðŸ”¹ Table Section -->
        <div class="table-container">
            <table id="tripTable">
                <thead>
                    <tr>
                        <th>Sl.no</th>
                        <th>Code</th>
                        <th>Vehicle No:</th>
                        <th>Vehicle Type</th>
                        <th>KM Rate</th>
                        <th>E.Hr.Rate</th>
                        <th>Fixed</th>
                        <th>Toll Parking</th>
                        <th>Haulting</th>
                        <th>M. Fixed</th>
                        <th>Gross Amount</th>
                        <th>Tax %</th>
                        <th style="background-color: gray;color: white;">Net Value</th>
                    </tr>
                </thead>
                <tbody>
                    {% if trips %}
                        {% for trip in trips %}
                                <input type="hidden" name="trip_id[]" value="{{ trip.id }}">
                                <tr data-trip-id="{{ trip.id }}" data-tax="{{ trip.tax }}">
                                    <td>{{ forloop.counter }}</td>
                                    <td>{{ trip.code }}</td>
                                    <td>{{ trip.vehicle_no }}</td>
                                    <td>{{ trip.vehicle_type }}</td>
                                    <td><input type="number" class="table_data" name="km_rate_{{trip.id}}" value="{{ trip.km_rate|default_if_none:'0.00' }}" data-type="km_rate"></td>
                                    <td><input type="number" class="table_data" name="extra_hour_rate_{{ trip.id }}" value="{{ trip.ehr_rate|default_if_none:'0.00' }}" data-type="extra_hour_rate"></td>
                                    <td class="fixed-charge" id="fixed_charge_{{ trip.id }}">{{ trip.fixed_charge }}</td>
                                    <td><input type="number" class="table_data" name="toll_parking_{{ trip.id }}" value="{{ trip.toll_parking|default_if_none:'0.00' }}" data-type="toll_parking"></td>
                                    <td><input type="number" class="table_data" name="haulting_{{ trip.id }}" value="{{ trip.haulting|default_if_none:'0.00' }}" data-type="haulting"></td>
                                    <td>0.00</td>
                                    <td class="gross_amount_cell">{{ trip.gross_amount |default_if_none:'0.00' }}</td>
                                    <td>{{ trip.tax }}</td>
                                    <td class="net_value freight-value" style="background-color: gray; color: white;">{{ trip.net_value }}</td>
                                    <input type="hidden" name="net_values[]" class="net_value_input">
                                    <input type="hidden" name="freight_charges[]" class="freight_charges_input" value="{{ trip.gross_amount|default_if_none:'0.00' }}">
                                </tr>
                        {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="12" style="text-align: center;">No trips found for the selected criteria.</td>
                    </tr>
                    {% endif %}
                </tbody>
            </table>
        </div>

        <!-- ðŸ”¹ Expense Details Section -->
        <div class="row mt-4"></div>

        <div class="bottom-section">

            <div class="column first-column">
                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px; padding-left: 0px;">
                <label for="sp_disc_percent" class="">Sp. Disc (%)</label>
                </div>
                <!-- <div class="col-sm-2"> -->
                    <input type="number" class="form-control" name="sp_disc_percent" id="sp_disc_percent" value="{{ bill_master.sp_disc_perc }}" step="0.1">
                </div>

                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px; padding-left: 0px;">
                <label for="sp_disc_amt" class="">Sp. Disc (Amt)</label>
            </div>
                <!-- <div class="col-sm-2"> -->
                    <input type="number" class="form-control" name="sp_disc_amt" id="sp_disc_amt" value="{{ bill_master.sp_disc_amt }}" step="0.1">
                </div>

                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px; padding-left: 0px;">
                <label for="round_off" class="">Round Off</label>
            </div>
                <!-- <div class="col-sm-2"> -->
                    <input type="number" class="form-control" name="round_off" id="round_off" value="{{ bill_master.round_off }}" step="0.1" readonly>
                </div>
            </div>

            <div class="column second-column">
                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px;">
                <label for="total_gross" class="">Total Gross</label>
                <!-- <div class="col-sm-2"> -->
                    </div>
                    <input type="number" class="form-control" name="total_gross" id="total_gross" value="{{ bill_master.amt_before_tax }}" readonly>
                </div>

                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px;">
                <label for="total_discounts" class="">Total Discounts</label>
                <!-- <div class="col-sm-2"> -->
                    </div>
                    <input type="number" class="form-control" name="total_discounts" id="total_discounts" value="{{bill_master.total_discounts}}" step="0.01" readonly>
                </div>
            </div>

            <div class="column third-column">
                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px;">
                <label for="net_total" class="">Amt Before Tax</label>
                <!-- <div class="col-sm-2"> -->
                    </div>
                    <input type="number" class="form-control" name="net_total" id="net_total" value="{{ bill_master.amt_before_tax }}" readonly>
                </div>

                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px;">
                <label for="cgst" class="">CGST</label>
                <!-- <div class="col-sm-2"> -->
                    </div>
                    <input type="number" class="form-control" name="cgst" id="cgst" value="{{ bill_master.cgst }}" step="0.1" readonly>
                </div>

                <div class="d-flex align-items-center">
                    <div class="col-md-8 col-8" style="width: 100px;">
                <label for="sgst" class="">SGST</label>
                <!-- <div class="col-sm-2"> -->
                    </div>
                    <input type="number" class="form-control" name="sgst" id="sgst" value="{{ bill_master.sgst }}" step="0.1" readonly>
                </div>

                <div class="d-flex align-items-center ">
                    <div class="col-md-8 col-8" style="width: 100px;">
                <label for="igst" class="">IGST</label>
                    </div>
                    <input type="number" class="form-control" name="igst" id="igst" value="{{ bill_master.igst }}" step="0.1" readonly>
                </div>

                <div class="d-flex align-items-center">
                    <div class="col-md-8 col-8" style="width: 100px;">
                        <label for="grand_total" class="">Grand Total</label>
                    </div>
                    <input type="number" class="form-control" name="grand_total" id="grand_total" value="{{ bill_master.grand_total }}" readonly>
                    
                    <!-- Store the original total before any discount is applied -->
                    <input type="hidden" id="original_total" value="{{ bill_master.original_total }}">
                </div>
                
            </div>
        </div>
         <!-- Buttons -->
         <div class="">
            <div class="col-sm-12 text-end">
                <a href="{% url 'main:bill_search' %}" id="" class="btn btn-danger btn-sm">Cancel</a>
                <button type="submit" id="print-button" class="btn btn-secondary btn-sm print-button" name="action" value="save">Print</button>
                <button type="submit" id="" class="btn btn-success btn-sm" name="action" value="save">Save</button>
            </div>
    </div>
</form>


</div>
</div>

 </div>
</div>















<!-- --------------------------  INVOICE ----------------------------------- -->


<div id="invoice-section" style="display: none;">
    <div style="padding: 20px; font-family: Arial;">
        <!-- Company Header -->
        <div style="text-align: center; margin-bottom: 20px;">
            <h1 style="margin: 0; font-size: 28px;">{{ company.companyname }}</h1>
            <p style="margin: 5px 0;">
                {{ company.address1 }},
                {% if company.address2 %}{{ company.address2 }}, {% endif %}
                {% if company.address3 %}{{ company.address3 }}, {% endif %}
                PIN - {{ company.pinCode }}
            </p>
            <p style="margin: 0;">
                {% if company.phoneno %}Phone: {{ company.phoneno }}{% endif %}
                {% if company.mobile %}Phone: {{ company.mobile }}{% endif %}
                {% if company.phoneno and company.email %} | {% endif %}
                {% if company.email %}Email: {{ company.email }}{% endif %}
            </p>
        </div>

        <hr style="border: 0.5px solid #585858; margin: 3px 0;">
        <h2 style="text-align: center; margin: 5px 0;">INVOICE</h2>
        <hr style="border: 0.5px solid #585858; margin: 3px 0;">

        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 14px;">
            <!-- Left Column -->
            <div style="flex: 1;">
                <p><strong>Bill No:</strong> <span id="print-bill-no"></span></p>
                <p><strong>Bill Date:</strong> <span id="print-bill-date"></span></p>
            </div>
        
            <!-- Middle Column -->
            <div style="flex: 1; text-align: center;">
                <p style="font-weight: bold; font-size: 16px;">ORIGINAL / DUPLICATE / TRIPLICATE</p>
            </div>
        
            <!-- Right Column -->
            <div style="flex: 1; text-align: right;">
                <p><strong>GSTIN:</strong> {{ company.gst }}</p>
                <p><strong>PAN:</strong> {{ company.pan }}</p>
            </div>
        </div>

        <hr style="border: 0.5px solid #585858; margin: 3px 0;">

        <div style="display: flex; justify-content: space-between; margin-top: 10px; font-size: 14px;">
            <!-- Left Column -->
            <div style="flex: 1;">
                <p><strong>Billed To:</strong> <span id="print-billed-to"></span></p>
            </div>
        </div>

        <hr style="border: 0.5px solid #585858; margin: 3px 0;">

        <div style="margin-top: 10px; margin-bottom: 20px; font-size: 14px;">
            {% if account_master %}
            {{ account_master.address1 }}<br>
            {% if account_master.address2 %}{{ account_master.address2 }}<br>{% endif %}
            {% if account_master.address3 %}{{ account_master.address3 }}<br>{% endif %}
            <div>
                <strong>GST No:</strong> {{ account_master.gstno }} &nbsp;&nbsp;
                <strong>Phone:</strong> {{ account_master.mobile|default:account_master.telno }}
            </div>
            {% endif %}
        </div>

        <hr style="border: 0.5px solid #585858; margin: 3px 0;">

        <div style="display: flex; flex-direction: column; min-height: 100vh;">
            <!-- Content Section (Main Content) -->
            <div style="flex-grow: 1;">
                <!-- Table Section -->
                <div style="width: 100%;">
                    <table style="border: 1px solid black; border-collapse: collapse; width: 100%; font-size: 10px;">
                        <thead>
                            <tr style="background-color: #f2f2f2;">
                                <th style="padding: 2px;">Sl.no</th>
                                <th style="padding: 2px;">Code</th>
                                <th style="padding: 2px;">Vehicle No:</th>
                                <th style="padding: 2px;">Vehicle Type</th>
                                <th style="padding: 2px;">KM Rate</th>
                                <th style="padding: 2px;">E.Hr.Rate</th>
                                <th style="padding: 2px;">Fixed</th>
                                <th style="padding: 2px;">Toll Parking</th>
                                <th style="padding: 2px;">Haulting</th>
                                <th style="padding: 2px;">M. Fixed</th>
                                <th style="padding: 2px;">Gross Amount</th>
                                <th style="padding: 2px;">Tax %</th>
                                <th style="padding: 2px; color: black;">Net Value</th>
                            </tr>
                        </thead>
                        <tbody id="invoice-trip-body" style="height: 30px;">
                            <tr>
                                <td colspan="13">&nbsp;</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                
        



        <!-- Bank Details and Summary Section -->
        <div style="display: flex; justify-content: space-between; margin-top: 20px; margin-bottom: 30px;">
            <!-- Left - Bank Details -->
            <div style="width: 60%; padding-right: 30px; border-right: 1px solid #ccc;">
                <div style="text-align: center; font-weight: bold; margin-bottom: 17px;">Bank Details</div>

                <div style="display: flex;">
                    <div style="width: 40%;">
                        <div style="height: 40px;">Bank Name:</div>
                        <div style="height: 40px;">Branch:</div>
                        <div style="height: 40px;">Account Number:</div>
                        <div style="height: 40px;">IFSC Code:</div>
                    </div>
                    <div style="width: 60%;">
                        <div style="height: 40px;"><span id="print_bank_name">Federal Bank</span></div>
                        <div style="height: 40px;"><span id="print_branch">Palayam</span></div>
                        <div style="height: 40px;"><span id="print_account_no">852963741012365</span></div>
                        <div style="height: 40px;"><span id="print_ifsc">FDRL12345</span></div>
                    </div>
                </div>
            </div>

            <!-- Right - Calculation Summary -->
            <div style="width: 38%; padding-left: 20px;">
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>Gross Amount</div><div><span id="print_total_gross"></span></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>CGST</div><div><span id="print_cgst"></span></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>SGST</div><div><span id="print_sgst"></span></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>IGST</div><div><span id="print_igst"></span></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>SP. Disc (%)</div><div><span id="print_sp_disc_percent"></span></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>SP. Disc Amt</div><div><span id="print_sp_disc_amt"></span></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>Total Discounts</div><div><span id="print_total_discounts"></span></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                    <div>Round Off</div><div><span id="print_round_off"></span></div>
                </div>
                <div style="border-top: 1px solid #000; margin-top: 10px; padding-top: 8px; display: flex; justify-content: space-between; font-weight: bold;">
                    <div>Grand Total</div><div><span id="print_grand_total"></span></div>
                </div>
            </div>
        </div>

        <hr style="border: 0.5px solid #585858; margin: 3px 0;">

        <!-- Bottom Signature Section -->
        <div style="display: flex; justify-content: space-between; margin-top: 30px;">
            <div style="width: 60%;">
                <p>Total Amount in Words:</p>
                <span id="amount-in-words"></span>
                <p style="font-size: 12px; color: red;">
                    NB: All complaints should be reported within a week. Bill payments must be made immediately; otherwise, interest will be charged at 15% per annum.
                </p>
            </div>
            <div style="width: 35%; text-align: right;">
                <strong>For {{ company.companyname }}</strong>
                <div style="margin-top: 60px;">
                    Authorised Signatory
                </div>
            </div>
        </div>
    </div>
</div>
            <!-- End of Content Section -->
        </div>


<!-- --------------------------  INVOICE END ----------------------------------- -->




<script src="{% static 'vendor/jquery-3.2.1.min.js' %}"></script>

<!-- Bootstrap JS-->
<script src="{% static 'vendor/bootstrap-4.1/popper.min.js' %}"></script>
<script src="{% static 'vendor/bootstrap-4.1/bootstrap.min.js' %}"></script>
<!-- Vendor JS       -->
<script src="{% static 'vendor/slick/slick.min.js' %}">
</script>
<script src="{% static 'vendor/wow/wow.min.js' %}"></script>
<script src="{% static 'vendor/animsition/animsition.min.js' %}"></script>
<script src="{% static 'vendor/bootstrap-progressbar/bootstrap-progressbar.min.js' %}">
</script>
<script src="{% static 'vendor/counter-up/jquery.waypoints.min.js' %}"></script>
<script src="{% static 'vendor/counter-up/jquery.counterup.min.js' %}">
</script>
<script src="{% static 'vendor/circle-progress/circle-progress.min.js' %}"></script>
<script src="{% static 'vendor/perfect-scrollbar/perfect-scrollbar.js' %}"></script>
<script src="{% static 'vendor/chartjs/Chart.bundle.min.js' %}"></script>
<script src="{% static 'vendor/select2/select2.min.js' %}">
</script>

<!-- Main JS-->
<script src="{% static 'js/main.js' %}"></script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
        const inputs = document.querySelectorAll('.table_data');
    
        function updateTotals() {
            let totalGross = 0;
            const grossCells = document.querySelectorAll('.gross_amount_cell');
    
            grossCells.forEach(cell => {
                totalGross += parseFloat(cell.textContent || 0);
            });
    
            document.getElementById('total_gross').value = totalGross.toFixed(2);
            document.getElementById('net_total').value = totalGross.toFixed(2);
    
            let totalTax = parseFloat(document.getElementById('total_tax').value || 0);
            let cgst = totalTax / 2;
            let sgst = totalTax / 2;
    
            document.getElementById('cgst').value = cgst.toFixed(2);
            document.getElementById('sgst').value = sgst.toFixed(2);
    
            let grandTotal = totalGross + totalTax;
            const grandTotalInput = document.getElementById('grand_total');
            grandTotalInput.value = grandTotal.toFixed(2);
            grandTotalInput.setAttribute('data-original', grandTotal.toFixed(2));
    
            if (window.applyDiscountAndRound) window.applyDiscountAndRound();
        }
    
        inputs.forEach(input => {
            input.addEventListener('input', function () {
                const row = input.closest('tr');
                const tripId = row.dataset.tripId;
                const taxPercent = parseFloat(row.dataset.tax || 0);
    
                const kmRate = parseFloat(row.querySelector('[data-type="km_rate"]').value) || 0;
                const ehrRate = parseFloat(row.querySelector('[data-type="extra_hour_rate"]').value) || 0;
                const tollParking = parseFloat(row.querySelector('[data-type="toll_parking"]').value) || 0;
                const haulting = parseFloat(row.querySelector('[data-type="haulting"]').value) || 0;
                const fixedCharge = parseFloat(document.getElementById(`fixed_charge_${tripId}`)?.innerText || 0);
    
                const grossAmount = kmRate + ehrRate + tollParking + haulting + fixedCharge;
    
                const grossCell = row.querySelector('.gross_amount_cell');
                if (grossCell) grossCell.textContent = grossAmount.toFixed(2);
    
                const netValue = grossAmount + (grossAmount * taxPercent / 100);
                const netCell = row.querySelector('.net_value');
                if (netCell) netCell.textContent = netValue.toFixed(2);
    
                const netInput = row.querySelector('.net_value_input');
                if (netInput) netInput.value = netValue.toFixed(2);
    
                const freightInput = row.querySelector('.freight_charges_input');
                if (freightInput) freightInput.value = grossAmount.toFixed(2);
    
                updateTotals();
            });
        });
    
        // Call updateTotals once on page load
        updateTotals();
    });
    </script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        function updateGrandTotal() {
            let grandTotal = 0;
    
            const netValueCells = document.querySelectorAll('.net_value');
            netValueCells.forEach(cell => {
                grandTotal += parseFloat(cell.textContent || 0);
            });
    
            const grandTotalInput = document.getElementById('grand_total');
            grandTotalInput.value = grandTotal.toFixed(2);
            grandTotalInput.setAttribute('data-original', grandTotal.toFixed(2));
    
            updateTaxValues(grandTotal);
    
            if (window.applyDiscountAndRound) window.applyDiscountAndRound();
        }
    
        function updateTaxValues(grandTotal) {
            const amtBeforeTax = parseFloat(document.getElementById('total_gross').value || 0);
            const gstType = document.getElementById('gst_type').value;
    
            if (grandTotal > amtBeforeTax) {
                const taxAmount = grandTotal - amtBeforeTax;
    
                if (gstType === 'gst') {
                    document.getElementById('cgst').value = (taxAmount / 2).toFixed(2);
                    document.getElementById('sgst').value = (taxAmount / 2).toFixed(2);
                    document.getElementById('igst').value = '0.00';
                } else if (gstType === 'igst') {
                    document.getElementById('cgst').value = '0.00';
                    document.getElementById('sgst').value = '0.00';
                    document.getElementById('igst').value = taxAmount.toFixed(2);
                }
            }
        }
    
        const inputs = document.querySelectorAll('.table_data');
        inputs.forEach(input => {
            input.addEventListener('input', function () {
                const row = input.closest('tr');
                updateRowTotals(row);
                updateGrandTotal();
            });
        });
    
        function updateRowTotals(row) {
            const kmRate = parseFloat(row.querySelector('[name^="km_rate"]').value || 0);
            const ehrRate = parseFloat(row.querySelector('[name^="extra_hour_rate"]').value || 0);
            const tollParking = parseFloat(row.querySelector('[name^="toll_parking"]').value || 0);
            const haulting = parseFloat(row.querySelector('[name^="haulting"]').value || 0);
            const fixedCharge = parseFloat(row.querySelector('.fixed-charge').innerText || 0);
    
            const grossAmount = kmRate + ehrRate + tollParking + haulting + fixedCharge;
            const grossCell = row.querySelector('.gross_amount_cell');
            grossCell.textContent = grossAmount.toFixed(2);
    
            const taxPercent = parseFloat(row.dataset.tax || 0);
            const netValue = grossAmount + (grossAmount * taxPercent / 100);
    
            const netCell = row.querySelector('.net_value');
            netCell.textContent = netValue.toFixed(2);
    
            const netInput = row.querySelector('.net_value_input');
            if (netInput) netInput.value = netValue.toFixed(2);
        }
    
        const gstTypeSelect = document.getElementById('gst_type');
        gstTypeSelect.addEventListener('change', updateGrandTotal);
    
        const rows = document.querySelectorAll('tr');
        rows.forEach(row => updateRowTotals(row));
        updateGrandTotal();
    });
    </script>
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const rows = document.querySelectorAll('tr');

    rows.forEach(row => {
        const netCell = row.querySelector('.net_value');
        const netInput = row.querySelector('.net_value_input');
        const freightInput = row.querySelector('.freight_charges_input');
        const grossCell = row.querySelector('.gross_amount_cell');

        // Default net value
        if (netCell && netInput && netInput.value === '') {
            const val = parseFloat(netCell.textContent) || 0;
            netInput.value = val.toFixed(2);
        }

        // Default freight charge
        if (grossCell && freightInput && freightInput.value === '') {
            const val = parseFloat(grossCell.textContent) || 0;
            freightInput.value = val.toFixed(2);
        }
    });
});

</script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const discPercentInput = document.getElementById('sp_disc_percent');
        const discAmtInput = document.getElementById('sp_disc_amt');
        const grandTotalInput = document.getElementById('grand_total');
    
        // Ensure the grand total has a data-original value set when it's initially calculated.
        const originalGrandTotal = parseFloat(grandTotalInput.getAttribute('data-original') || 0);
    
        discPercentInput.addEventListener('input', function () {
            const discountPercent = parseFloat(discPercentInput.value || 0);
    
            if (!isNaN(discountPercent) && originalGrandTotal > 0) {
                // Calculate discount amount
                const discountAmount = (originalGrandTotal * discountPercent) / 100;
                const updatedGrandTotal = originalGrandTotal - discountAmount;
    
                // Make sure the grand total doesn't go below zero
                if (updatedGrandTotal < 0) {
                    grandTotalInput.value = '0.00';
                } else {
                    grandTotalInput.value = updatedGrandTotal.toFixed(2);
                }
    
                // Update discount amount input
                discAmtInput.value = discountAmount.toFixed(2);
            } else {
                // If no valid discount is applied, reset to original grand total
                discAmtInput.value = '0.00';
                grandTotalInput.value = originalGrandTotal.toFixed(2);
            }
        });
    });
    </script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const spDiscPercent = document.getElementById('sp_disc_percent');
        const spDiscAmt = document.getElementById('sp_disc_amt');
        const roundOff = document.getElementById('round_off');
        const grandTotal = document.getElementById('grand_total');
        const totalDiscounts = document.getElementById('total_discounts');
    
        // Initial set
        const originalTotal = document.getElementById('original_total');
        if (grandTotal && originalTotal) {
            grandTotal.setAttribute('data-original', originalTotal.value);
            grandTotal.value = originalTotal.value;  // Start from base amount
        }
        
        function applyDiscountAndRound() {
            let originalGrandTotal = parseFloat(document.getElementById('original_total').value) || 0;
            let percentDiscount = parseFloat(spDiscPercent?.value) || 0;
            let amountDiscount = parseFloat(spDiscAmt?.value) || 0;
    
            // Calculate percentage discount and total discount
            let percentDiscountAmt = (originalGrandTotal * percentDiscount) / 100;
            let totalDiscount = percentDiscountAmt + amountDiscount;
    
            let discountedTotal = originalGrandTotal - totalDiscount;
            let roundedTotal = Math.round(discountedTotal);  // âœ… Whole number
            let calculatedRoundOff = round2(roundedTotal - discountedTotal);
    
            // Update grand total and rounding fields
            grandTotal.value = roundedTotal.toFixed(2);
            if (roundOff) roundOff.value = calculatedRoundOff.toFixed(2);
    
            // Update total discount field (either in percentage or amount)
            if (totalDiscounts) {
                totalDiscounts.value = totalDiscount.toFixed(2);  // Show total discount amount
            }
        }
    
        // Add event listeners for discount fields
        [spDiscPercent, spDiscAmt].forEach(el => {
            if (el) el.addEventListener('input', applyDiscountAndRound);
        });
    
        // Expose to global scope
        window.applyDiscountAndRound = applyDiscountAndRound;
    
        // Call once on page load to ensure everything is set correctly
        applyDiscountAndRound();
    });
</script>





<!-- --------------------------   SCRIPT FOR INVOICE     ---------------------- -->


<script>
    document.getElementById("print-button").addEventListener("click", function () {
        const billNo = document.getElementById("entry_number").value;
        const billDateRaw = document.getElementById("bill_date").value;
        const billDateParts = billDateRaw.split("-");
        const billDateFormatted = `${billDateParts[2]}-${billDateParts[1]}-${billDateParts[0]}`;
        const billedTo = document.getElementById("customer_name").value;
    
        document.getElementById("print-bill-no").textContent = billNo;
        document.getElementById("print-bill-date").textContent = billDateFormatted;
        document.getElementById("print-billed-to").textContent = billedTo;
        document.getElementById("print_total_gross").textContent = document.getElementById("total_gross").value;
        document.getElementById("print_cgst").textContent = document.getElementById("cgst").value;
        document.getElementById("print_sgst").textContent = document.getElementById("sgst").value;
        document.getElementById("print_igst").textContent = document.getElementById("igst").value;
        document.getElementById("print_sp_disc_percent").textContent = document.getElementById("sp_disc_percent").value;
        document.getElementById("print_sp_disc_amt").textContent = document.getElementById("sp_disc_amt").value;
        document.getElementById("print_total_discounts").textContent = document.getElementById("total_discounts").value;
        document.getElementById("print_round_off").textContent = document.getElementById("round_off").value;
        document.getElementById("print_grand_total").textContent = document.getElementById("grand_total").value;
    
        // âœ… Convert and insert amount in words
        const grandTotal = parseFloat(document.getElementById("grand_total").value || 0);
        const amountWords = convertNumberToWords(grandTotal);
        document.getElementById("amount-in-words").textContent = amountWords;
    
        // Update invoice table
        const invoiceBody = document.getElementById("invoice-trip-body");
        invoiceBody.innerHTML = "";
        
        const tripRows = document.querySelectorAll("#tripTable tbody tr");
        tripRows.forEach((row, index) => {
            const entryNo = row.children[1]?.innerText.trim();
            const vehicleNo = row.children[2]?.innerText.trim();
            const vehicleType = row.children[3]?.innerText.trim();
    
            const kmRate = row.querySelector(`[name^='km_rate_']`)?.value || '0.00';
            const extraHrRate = row.querySelector(`[name^='extra_hour_rate_']`)?.value || '0.00';
            const fixedCharge = row.querySelector(".fixed-charge")?.textContent.trim() || '0.00';
            const tollParking = row.querySelector(`[name^='toll_parking_']`)?.value || '0.00';
            const haulting = row.querySelector(`[name^='haulting_']`)?.value || '0.00';
            const tax = row.children[10]?.innerText.trim();
            const grossAmount = row.children[11]?.innerText.trim(); 
            const netValue = row.querySelector(".net_value")?.innerText.trim() || '0.00';
    
            const printRow = `
                <tr>
                    <td>${index + 1}</td>
                    <td>${entryNo}</td>
                    <td>${vehicleNo}</td>
                    <td>${vehicleType}</td>
                    <td>${kmRate}</td>
                    <td>${extraHrRate}</td>
                    <td>${fixedCharge}</td>
                    <td>${tollParking}</td>
                    <td>${haulting}</td>
                    <td>0.00</td>
                    <td>${tax}</td>
                    <td>${grossAmount}</td>
                    <td style="background-color: gray; color: black;">${netValue}</td>
                </tr>
            `;
            invoiceBody.innerHTML += printRow;
        });
    
        // Print
        const printContents = document.getElementById("invoice-section").innerHTML;
        const printWindow = window.open('', '', 'height=800,width=1000');
    
        printWindow.document.write(`
            <html>
            <head>
                <title>Invoice</title>
                <style>
                    body { font-family: Arial, sans-serif; padding: 20px; }
                    table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                    th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                    th { background-color: #f2f2f2; }
                    hr { border: 0.5px solid #ccc; margin: 10px 0; }
                </style>
            </head>
            <body>
                ${printContents}
                </body>
            </html>
        `);
    
        printWindow.document.close();
        printWindow.focus();
        printWindow.print();
        printWindow.close();
    });
    
    function convertNumberToWords(amount) {
    var words = ['', 'One', 'Two', 'Three', 'Four', 'Five', 'Six', 'Seven', 'Eight', 'Nine', 'Ten',
        'Eleven', 'Twelve', 'Thirteen', 'Fourteen', 'Fifteen', 'Sixteen', 'Seventeen', 'Eighteen', 'Nineteen'];
    var tens = ['', '', 'Twenty', 'Thirty', 'Forty', 'Fifty', 'Sixty', 'Seventy', 'Eighty', 'Ninety'];

    function numToWords(n) {
        if (n < 20) return words[n];
        if (n < 100) return tens[Math.floor(n / 10)] + (n % 10 ? " " + words[n % 10] : "");
        if (n < 1000) return words[Math.floor(n / 100)] + " Hundred" + (n % 100 ? " and " + numToWords(n % 100) : "");
        if (n < 100000) return numToWords(Math.floor(n / 1000)) + " Thousand" + (n % 1000 ? " " + numToWords(n % 1000) : "");
        if (n < 10000000) return numToWords(Math.floor(n / 100000)) + " Lakh" + (n % 100000 ? " " + numToWords(n % 100000) : "");
        return numToWords(Math.floor(n / 10000000)) + " Crore" + (n % 10000000 ? " " + numToWords(n % 10000000) : "");
    }

    if (amount === 0) return "Zero Rupees Only";

    const rounded = Math.round(amount);
    return numToWords(rounded) + " Rupees Only";
}
    </script>
    
    
<!-- --------------------------   SCRIPT FOR INVOICE END     ---------------------- -->



{% if status == 'success' %}
<script>
    Swal.fire({
        icon: 'success',
        title: 'Success',
        text: 'Bill Saved Successfully',
        confirmButtonText: 'OK',
    }).then((result) => {
        if (result.isConfirmed) {
            window.location.href = "/bill_search/"; // Replace with your target URL
        }
    });
</script>
{% elif status == 'error' %}
<script>
    Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Error Saving The Bill',
        confirmButtonText: 'OK'
    });
</script>
{% endif %}

<script>
    function round2(val) {
        return Math.round(val * 100) / 100;
    }
    
    function updateRowAndTotals(row) {
        const taxPercent = parseFloat(row.dataset.tax || 0);
    
        const kmRate = parseFloat(row.querySelector('[data-type="km_rate"]')?.value || 0);
        const ehrRate = parseFloat(row.querySelector('[data-type="extra_hour_rate"]')?.value || 0);
        const toll = parseFloat(row.querySelector('[data-type="toll_parking"]')?.value || 0);
        const haulting = parseFloat(row.querySelector('[data-type="haulting"]')?.value || 0);
        const fixed = parseFloat(row.querySelector('.fixed-charge')?.innerText || 0);
    
        const gross = round2(kmRate + ehrRate + toll + haulting + fixed);
        const net = round2(gross + (gross * taxPercent / 100));
    
        // Update cells and hidden inputs
        row.querySelector('.gross_amount_cell').textContent = gross.toFixed(2);
        row.querySelector('.net_value').textContent = net.toFixed(2);
    
        const netInput = row.querySelector('.net_value_input');
        if (netInput) netInput.value = net.toFixed(2);
    
        const freightInput = row.querySelector('.freight_charges_input');
        if (freightInput) freightInput.value = gross.toFixed(2);
    }
    
    function updateGrandTotal() {
    let grandTotal = 0;
    document.querySelectorAll('.net_value_input').forEach(input => {
        const val = parseFloat(input.value);
        if (!isNaN(val)) grandTotal += val;
    });

    const rawTotal = round2(grandTotal);  // Sum with 2 decimals
    const roundedTotal = Math.round(rawTotal);  // Final rounded total
    const roundOffAmount = round2(roundedTotal - rawTotal);  // Difference

    document.getElementById('grand_total').value = roundedTotal.toFixed(2);
    document.getElementById('grand_total').setAttribute('data-original', roundedTotal.toFixed(2));
    document.getElementById('original_total').value = roundedTotal.toFixed(2);
    document.getElementById('round_off').value = roundOffAmount.toFixed(2);

    // Update taxes
    const gross = parseFloat(document.getElementById('total_gross').value || 0);
    const gstType = document.getElementById('gst_type')?.value || 'gst';
    const taxAmt = round2(rawTotal - gross);

    if (gstType === 'gst') {
        document.getElementById('cgst').value = (taxAmt / 2).toFixed(2);
        document.getElementById('sgst').value = (taxAmt / 2).toFixed(2);
        document.getElementById('igst').value = '0.00';
    } else {
        document.getElementById('cgst').value = '0.00';
        document.getElementById('sgst').value = '0.00';
        document.getElementById('igst').value = taxAmt.toFixed(2);
    }

    if (window.applyDiscountAndRound) window.applyDiscountAndRound();
}
    
    // Hook into all input changes
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.table_data').forEach(input => {
            input.addEventListener('input', function () {
                const row = input.closest('tr');
                updateRowAndTotals(row);
                updateGrandTotal();
            });
        });
    
        // Initial setup
        document.querySelectorAll('#tripTable tbody tr').forEach(row => updateRowAndTotals(row));
        updateGrandTotal();
    });
    </script>
    
{% endblock %}
